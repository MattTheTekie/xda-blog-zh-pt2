<html>
<head>
<title>SafetyNet's hardware attestation will make hiding root in Magisk really hard</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>安全网的硬件认证将使隐藏Magisk中的根变得非常困难</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/safetynet-hardware-attestation-hide-root-magisk/#0001-01-01">https://www.xda-developers.com/safetynet-hardware-attestation-hide-root-magisk/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>早在三月份，一些安装了Magisk的用户<a href="https://www.xda-developers.com/magisk-no-longer-hide-bootloader-unlock-status/">注意到</a>他们的设备没有通过安全网认证。这一消息令XDA的社区感到不安，因为这意味着许多重要的银行/金融应用程序和流行游戏，如Pokémon Go和Fate/Grand Order，拒绝在根设备上运行。一段时间以来，SafetyNet中收紧的限制似乎被收回了，只是在过去几周内又向少数用户推出了。然而，谷歌在5月初悄悄证实，他们正在测试硬件支持的SafetyNet响应证明，这使得Magisk无法隐藏3月份的引导加载程序解锁状态。如果这一变化广泛展开，这将意味着用户将不得不在访问根/自定义ROMs内核/等之间做出选择。或者他们喜欢的银行应用和游戏。Android对高级用户的最大吸引力之一可能很快就会消失。</p>

  
<p>为了概括这一系列事件，我们应该首先谈谈安全网本身。SafetyNet是Google Play服务中的一组API。SafetyNet证明API就是这些API中的一种，它可以被第三方应用程序调用，以检查设备的软件环境是否被以任何方式篡改。API检查各种东西，比如超级用户二进制文件的标志、引导加载程序解锁状态等等。当你用Magisk给一个设备根时，它“为[安全网]检测过程[创建]了一个隔离的'安全环境'，它通过谷歌的API创建了一个不反映设备真实状态的<em>合法</em>安全网结果，”XDA资深公认开发人员<a href="https://forum.xda-developers.com/member.php?u=4470081"> topjohnwu </a>说。这允许用户根他们的电话，同时确保API对于任何引导装载器解锁检查总是返回“假”。这种绕过SafetyNet的引导加载程序解锁检测的方法在过去几年里一直适用于Magisk，但这只是因为谷歌推迟了使用硬件证明验证引导映像的完整性。今年3月，谷歌似乎终于开始在SafetyNet中采用硬件认证来验证启动映像，但我们从未从谷歌获得官方声明来确认这一变化，只有少数用户受到影响。然而，正如XDA资深成员<a href="https://forum.xda-developers.com/member.php?u=6345368"> Displax </a>所指出的，谷歌在2020年5月5日确认，来自一些设备的安全网认证API响应现在包括硬件支持的检查。</p>

<p>在“安全网API客户端”的Google小组上，Google详细介绍了认证API的一个新特性:evaluationType。来自某些设备的JSON Web签名(JWS)响应将具有一个名为“evaluationType”的字段，该字段“将为开发人员提供对每个单独的安全网证明API响应有贡献的信号/测量类型的洞察”该字段中支持的令牌之一是“HARDWARE_BACKED ”,其指示API“使用了远程设备的可用硬件支持的安全特征(例如，<a href="https://developer.android.com/training/articles/security-key-attestation">硬件支持的密钥证明</a>)来影响[其]评估。”谷歌表示，他们“目前正在评估和调整设备的资格标准，我们将依赖硬件支持的安全功能。”这意味着，在一些设备上，Google Play服务现在使用硬件支持的证明来检测设备的软件是否被篡改。谷歌没有在谷歌集团的公告之外正式记录这一变化，所以一些使用SafetyNet的开发人员可能不知道这一变化(因此还没有检查JWS响应中的“HARDWARE_BACKED”字段。)然而，对于那些正在检查这一领域的应用程序，现在没有办法对他们隐藏root访问权限，只要你的设备是谷歌正在进行的测试的一部分。</p>





<p>根据topjohnwu的说法，硬件支持的证明意味着Google Play服务现在“向SafetyNet服务器[发送]未经修改的密钥库证书，[验证]其合法性，并[检查]证书扩展数据，以了解您的设备是否[已]验证启动启用(引导加载程序状态)。”由于密钥库证书所源自的私钥是由电话的隔离安全环境支持的，因此检索它们将涉及破坏电话的可信执行环境(TEE)或专用硬件安全模块(HSM)的安全性。如果有人以某种方式泄露了私钥，一旦谷歌发现，<a href="https://twitter.com/shawnwillden/status/1237836365238337536">密钥将很快被撤销</a>。谷歌为任何影响Pixel手机TEE的关键安全漏洞提供了数十万美元的奖励，这只是表明这不太可能成为绕过引导加载程序解锁检测的潜在途径。</p>

<p>Magisk可以继续欺骗引导加载程序解锁状态的另一个潜在方法是修改SafetyNet的客户端代码，使其始终使用基本评估。然而，正如topjohnwu指出的那样，这需要通过类似Xposed框架的挂钩框架将定制代码注入到Google Play服务中。这不仅很难做到，因为Google Play服务非常混乱，而且也不可能隐藏，因为“一些内存空间分析将非常容易地揭示代码操纵。”此外，这也只有在谷歌的服务器继续接受基本评估，并且在支持硬件的设备上不强制执行硬件支持的评估的情况下才有效。(根据topjohnwu的说法，安全网的响应“[来自]谷歌服务器，并用谷歌的私钥签名”，因此实际的响应不可能是欺骗的。)</p>

<p>自Android 7 Nougat以来，谷歌要求所有设备都有一个隔离的安全环境，这意味着SafetyNet如何验证引导加载程序解锁的这一变化将影响大多数设备。由于没有隔离安全环境的旧设备显然无法执行硬件支持的证明，Magisk仍将能够隐藏这些设备上的root访问。但如果这一变化大范围展开，其他人将不得不在root访问和银行应用之间做出艰难的选择。</p>

<p>不幸的是，可能有很多应用程序在不需要的时候使用安全网检查。topjohnwu引用的一个例子是麦当劳的官方应用程序，它似乎拒绝在bootloader解锁的设备上运行。在Twitter上，topjohnwu指出过度使用API的应用程序为高级用户创造了一个充满敌意的环境。XDA认可的开发人员Quinny899 讲述了他的团队如何考虑使用SafetyNet来检查设备安全状态的轶事。他们最终决定不这么做，因为他的团队的应用程序会加密所有敏感数据。他认为，安全网不应该用来代替适当的安全和数据处理实践，尤其是考虑到超级用户利用的<a href="https://www.xda-developers.com/mediatek-su-rootkit-exploit/">可能性。</a></p>

 



<p>有关新的安全网变化如何影响Magisk的更多信息，请查看topjohnwu在Twitter 上的<a href="https://twitter.com/topjohnwu/status/1237830555523149824">精彩FAQ。如果你只是想检查你的设备是否是谷歌新安全网测试的一部分，那么你可以遵循XDA高级会员Displax的</a><a href="https://forum.xda-developers.com/showpost.php?p=82935207&amp;postcount=40370">这个指南</a>或者下载最新的Magisk Manager版本。</p>

 



<hr/>

<p><em>本文更新于美国东部时间2020年6月30日上午10:46，更正谷歌只对Pixel手机中发现的TEE漏洞进行悬赏。此外，添加了有关最新Magisk Manager版本的详细信息，该版本现在显示内置SafetyNet checker中的evaluationType字段。</em></p>

 </div>


</div>    
</body>
</html>