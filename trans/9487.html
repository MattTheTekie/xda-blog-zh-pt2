<html>
<head>
<title>Kirisakura custom kernel for the OnePlus 8 Pro enables Control Flow Integrity (CFI) for better security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>一加8 Pro的Kirisakura定制内核支持控制流完整性(CFI)以获得更好的安全性</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/kirisakura-custom-kernel-for-the-oneplus-8-pro-enables-control-flow-integrity-cfi-for-better-security/#0001-01-01">https://www.xda-developers.com/kirisakura-custom-kernel-for-the-oneplus-8-pro-enables-control-flow-integrity-cfi-for-better-security/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>一加手机在修补者中很受欢迎，主要是因为该公司对开发者友好的态度，当然还有其无痛引导加载解锁政策。公司本身并不害怕尝试，改装者也完全接受同样的想法。例如，一加手机是首批支持<a href="https://www.xda-developers.com/google-pixel-fastest-android-phone-eas/">节能调度</a> (EAS)的非像素设备，这要归功于XDA丰富的售后市场开发社区。这就是为什么第三方内核在XDA总是受欢迎的一个重要原因，因为它们可以被定制以引入新的性能特性和安全措施。</p>

  
<p>XDA公认的开发者freak 07 T1，更为人所知的是Kirisakura内核的维护者，现在已经通过他的定制内核为一加8 Pro引入了一个漂亮的安全功能。这种机制被称为<strong>控制流完整性</strong> (CFI)，它被设计成一种运行时强化特性，但也可以被归类为一种bug查找工具——使其非常独特。</p>

<p/><p><strong> <a href="https://forum.xda-developers.com/oneplus-8-pro">一加八大职业XDA论坛</a> </strong></p>

 

<p>通过修复可利用的代码来提高安全性是内核开发的一个非常重要的方面。除其他外，这是由每月的Android安全更新定期完成的。</p>

<p>然而，众所周知，并非所有OEM厂商都像我们希望的那样定期推出这些更新。此外，Android内核由成千上万行代码组成，这些代码都不在树中。由于Android内核的复杂性和规模，以及Android生态系统的多样性，很难修复每一个漏洞。与其修复每一行可被利用的代码，不如通过使现有的安全缺陷不可被利用来使系统更能抵御攻击。这种技术被称为硬化。</p>

<p>这就是控制流完整性(CFI)发挥作用的地方。CFI是一种安全机制，它不允许对编译后的二进制文件的原始控制流图进行更改。由于<a href="https://android-developers.googleblog.com/2016/07/protecting-android-with-more-linux.html">现有的内存保护</a>使得代码注入更加困难，一种常见的攻击手段是覆盖内存中存储的函数指针。</p>

<p>下面是Freak07的一个技术解释，它对控制流完整性做了更多的解释:</p>

<section class="emaki-custom-block emaki-custom-expandable"><div class="emaki-custom expandable" id="custom_block_8"><h3 id="technical-details-about-control-flow-integrity">关于控制流完整性的技术细节</h3><p>“内核中大量函数指针的可用性助长了这种攻击模式的流行。即使攻击者不能注入他们自己的可执行代码，也可以执行现有内核代码的任意部分来完成他们的攻击。</p><p>LLVM 的CFI试图通过限制有效调用目标并在检测到CFI违规时强制内核崩溃来缓解这些攻击。在每个间接分支之前添加检查，以确认目标地址指向具有正确签名的有效函数。这防止了间接分支跳转到任意代码位置，甚至限制了可以调用的函数。如果漏洞允许访问，攻击者仍然可以更改函数指针。但是LLVM的CFI将55%的间接呼叫限制为最多5个可能的目标，将80%的间接呼叫限制为最多20个目标。为了确定每个间接分支的所有有效调用目标，编译器需要一次看到所有内核代码。</p><p>LTO ( <a href="https://llvm.org/docs/LinkTimeOptimization.html">链路时间优化</a>)的使用使这成为可能。LLVM的CFI需要使用LTO，其中编译器为所有C编译单元生成特定于LLVM的位代码，支持LTO的链接器使用LLVM后端将位代码合并并编译成本机代码。</p><p>作为允许使用CFI的补充，LTO通过整体程序分析和跨模块优化实现了更好的运行时性能。</p><p><a href="http://blog.llvm.org/2016/06/thinlto-scalable-and-incremental-lto.html"> ThinLTO </a>几乎赶上了LTOs的性能提升。在ThinLTO模式下，与常规LTO一样，<a href="https://clang.llvm.org/"> Clang </a>在编译阶段后发出LLVM位代码。ThinLTO位代码增加了模块的压缩摘要。在链接步骤期间，仅读取摘要并将其合并到组合摘要索引中，该索引包括用于以后跨模块函数导入的函数位置索引。然后，对组合的摘要索引进行快速有效的整体程序分析。ThinLTO允许多线程链接过程，从而减少编译时间。</p><p>由于CFI在遇到某些bug类时会中断程序的执行，所以如前所述，当在许可模式下使用时，它也被归类为bug查找工具。许可CFI将在内核日志中显示CFI违规，而不会导致内核崩溃。core 4.9 (Pixel 3代设备)和4.14 (Pixel 4代设备)内核有几个函数类型不匹配，导致CFI违规，Google在内核/公共回购上可用的补丁集中解决了这些问题。</p><p>然而，由于Android生态系统的性质，这些不匹配很可能会在SoC制造商(在这种情况下，高通)或OEM(一加)的特定代码中发现。一加8 Pro的Kirisakura内核修复了高通代码中几个与4.19内核不同的CFI违规问题(例如:<a href="https://github.com/freak07/Kirisakura_OP8PRO_InstantNoodle/commit/9982e3c2793de95f12ff2c8bcf6adc924359e254"> 1 </a>、<a href="https://github.com/freak07/Kirisakura_OP8PRO_InstantNoodle/commit/090419042846c119dc8d8f2133493d53e9ce9301"> 2 </a>、<a href="https://github.com/freak07/Kirisakura_OP8PRO_InstantNoodle/commit/f3be2647ad6ef562d5d91ac95ee41ebcf0d38f01"> 3 </a>)。</p><p>在许可的CFI中运行内核揭示了与一加驱动程序相关的代码中的CFI违规(相关的提交可以在这里的<a href="https://github.com/freak07/Kirisakura_OP8PRO_InstantNoodle/commit/202da10e9b256443d10e9aff4f10b34d251613f0">和这里</a>的<a href="https://github.com/freak07/Kirisakura_OP8PRO_InstantNoodle/commit/9f320aa5cb1a7d1581ef7b3fc513e452b2931451">中找到)。一加8 Pro的Kirisakura内核在CFI强制下运行，保护其用户免受这种代码重用攻击。"</a></p> </div></section>
<p>据我们所知，唯一正式支持CFI的Android智能手机型号是谷歌<a href="https://forum.xda-developers.com/pixel-3"> Pixel 3 </a>和<a href="https://forum.xda-developers.com/pixel-4"> Pixel 4 </a>系列。开发者告诉我们，他的内核是少数几个拥有完全工作的<a href="https://security.googleblog.com/2018/10/posted-by-sami-tolvanen-staff-software.html">内核——CFI</a>的定制内核之一。一加7 Pro论坛上还有另一个内核<a href="https://forum.xda-developers.com/oneplus-7/oneplus-7-7-pro-7t-7t-pro-cross-device-kernel-development/kernel-glassrom-kernel-t4009237">，它支持Kernel-CFI以及</a><a href="https://forum.xda-developers.com/member.php?u=3428502"> Freak07 </a>自己为华硕ROG手机II 开发的<a href="https://forum.xda-developers.com/rog-phone-2/development/kernel-kirisakura-1-0-0-asus-rog-phone-t4028237"> Kirisakura内核，但他为一加8 Pro发布的内核是第一个为使用Linux内核版本4.19的设备定制的、强制执行CFI的内核。</a></p>

<p/><p><strong> <a href="https://forum.xda-developers.com/oneplus-8-pro/development/kernel-kirisakura-1-0-0-oneplus-8-pro-t4119585"> Kirisakura kernel for the一加8 Pro — XDA下载与讨论线程</a> </strong></p>

<p>如果设备运行的是Android 9 Pie或更高版本，谷歌强烈建议使用Kernel-CFI。随着原始设备制造商有时会落后于最近的安全更新几个月，以及我们的手机越来越多地与我们的生活联系在一起，保存着宝贵的私人数据，专注于强化系统的安全功能确实是我们个人智能手机的一个受欢迎的补充。但是，还有其他的内核安全特性，即使不比Kernel-CFI更重要，也是同样重要的，所以不要把CFI当作防止所有缺陷的灵丹妙药。</p>

 </div>


</div>    
</body>
</html>