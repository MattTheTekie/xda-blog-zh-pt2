<html>
<head>
<title>Dynamic System Updates in Android Q: How Project Treble will improve future Android versions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Android中的动态系统更新问:Project Treble将如何改进未来的Android版本</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/android-q-dynamic-system-updates-project-treble/#0001-01-01">https://www.xda-developers.com/android-q-dynamic-system-updates-project-treble/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>随着Android 8.0 Oreo的发布，谷歌公布了三重项目(Project Treble)T1:Android OS框架和厂商HALs和Linux内核通信方式的重大重组。Treble是一项旨在减少Android平台版本和<a href="https://www.xda-developers.com/linux-kernel-long-term-support-google/">安全补丁碎片</a>的重大举措，所有使用Android Pie发布的Android品牌设备都需要支持Treble项目。原始设备制造商和供应商通过启动通用系统映像(GSI)——AOSP Android的纯库存版本——并通过<a href="https://source.android.com/compatibility/vts">供应商测试套件</a> (VTS)和通用系统映像兼容性测试套件(CTS-on-GSI)，来测试三重兼容性。事实证明，GSI不仅允许为原始设备制造商工作的软件工程师测试三重兼容性，还为XDA的大型定制ROM社区打开了大门。对于Android Q版本，谷歌希望让GSIs对另一个群体有用:应用开发者。</p>

  
<p>由于任何给定的Android平台版本的第一个稳定版本和源代码发布通常在8月到来<a href="https://www.xda-developers.com/android-pie-source-code-aosp/">，如果开发人员希望在真实设备上测试下一个Android版本，他们通常需要使用谷歌智能手机，如果他们不想等待更新到达他们自己的硬件的话。然而，谷歌去年与原始设备制造商合作，为几款设备推出了</a><a href="https://www.xda-developers.com/android-p-beta-program-is-now-available/">安卓P beta </a>，今年他们又推出了<a href="https://www.xda-developers.com/android-q-beta-3-released/">安卓Q beta </a>。除了正式的Android Q测试版，谷歌今年还发布了正式的Q测试版GSI，因此任何拥有Project Treble兼容设备的开发人员都可以安装最新的Q版本，而不必等待数月才能到达他们的设备。这种测试下一个Android版本的新方法给了开发者更多的机会，因此也给了他们更多的时间，来测试他们的应用程序对Android 的重大改变。</p>

<p>不幸的是，目前安装GSI的方法很困难。它需要解锁引导加载程序，这意味着擦除所有用户数据和/或取消保修，并通过快速引导协议刷新映像。如果他们的设备<a href="https://www.xda-developers.com/xda-huawei-decision-stop-bootloader-unlocking/">甚至允许解锁引导程序</a>，这对于一个应用开发者来说并不是一个快速简单的过程。这就是为什么在过去几个月的<a href="https://www.xda-developers.com/android-q-dynamic-android-aosp-gsi/"/>里，谷歌一直在研究一种启动GSIs的新方法。输入一个新功能，称为动态系统更新，或DSU。</p>

<p>(这项功能之前是以“实时图像”、“动态Android”和“Android on Tap”的名称开发的，所以如果谷歌在几周或几个月后称之为其他东西，不要感到惊讶。)</p>

 
<h2 id="dynamic-system-updates-in-android-q">Android Q中的动态系统更新</h2>
<p>DSU特性的目标是允许开发人员在不干扰当前安装的情况下启动到GSI。这意味着不需要解锁引导加载程序，也不需要擦除用户数据。安装过程也大大简化了，因为谷歌已经通过ADB提供了一个命令行界面和一个可以通过意图控制的应用程序。下面是使用DSU启动GSI的样子:</p>

 
<p class="w-rich w-youtube" id="Hp1j9vZxWoo">  </p>


<p>在该视频*中，运行Android Q beta 3的谷歌Pixel 3 XL重启进入GSI。在这种环境下，应用程序开发人员可以安装并测试他们的应用程序的Q API兼容性。当他们完成测试后，他们可以简单地重新启动设备上的常规Q beta 3软件。你基本上是双启动GSI，所以你可以安全地测试你的应用程序！</p>

<p>*我们在谷歌I/O 2019上录制了这个视频，当时DSU还没有公开发布，所以在拍摄的Pixel 3 XL上的Q beta 3版本被谷歌稍微修改了一下，以包括DSU支持。如果符合以下要求，运行Q beta 4和更高版本的设备有资格支持DSU。</p>

<h3 id="requirements-for-dynamic-system-updates">动态系统更新的要求</h3>
<p>对谷歌来说，实现双重启动和运行并非易事。谷歌的DSU测试平台Pixel 3的分区管理方式必须做出重大改变。因此，对DSU支持的第一个主要要求是设备支持动态分区。动态分区涉及一个真正的存储分区，它被划分成可调整大小的逻辑分区，如系统、供应商、odm、oem、产品等。在安装GSI的过程中，通过从现有的用户数据分区中取出未使用的块，为新的系统和用户数据分区保留空间。由于这些新分区的大小可能有几千兆字节，DSU支持仅对逻辑分区有意义，否则设备将需要永久保留几千兆字节的存储空间用于GSI安装。</p>

<p>其他需求包括一个ramdisk，它决定是引导到恢复、系统还是逻辑分区，以及一个元数据分区来存储GSI的元数据。根据项目三冠王Iliyan Malchev的说法，一般来说，DSU支持的构建模块是Android Q发布要求。我们不确定<em>支持DSU所需的一切</em>是否是Android Q发布的要求，但我们可以假设，即使不是所有的设备都发布了Android Q <em>也可以</em>支持DSU，即使谷歌目前没有要求他们这样做。到目前为止，只有Pixel 3、Pixel 3 XL、Pixel 3a和Pixel 3a XL具有动态分区，而在这些设备中，只有Pixel 3和Pixel 3 XL支持Android Q beta 4中的DSU。虽然DSU支持不是必需的，但谷歌希望原始设备制造商无论如何都能启用该功能，因为它简化了三重兼容性的安全测试。例如，OEM软件工程师可以将GSI <a href="https://android-review.googlesource.com/c/platform/system/gsid/+/928766">放在SD卡</a>上，这样他们就可以在多个设备上快速启动以测试三重兼容性。</p>

<h3 id="security-for-dynamic-system-updates">动态系统更新的安全性</h3>
<p>由于DSU本质上引入了第二个操作系统，谷歌需要确保这个新的安装不能被篡改，以破坏设备的完整性。因此，与原始安装相同的基本安全保护也适用于GSI安装:Android验证的引导和SELinux策略。此外，只有具有INSTALL _ DYNAMIC _ SYSTEM signature | privileged权限的应用程序可以启动GSI安装，而具有MANAGE_DYNAMIC_SYSTEM signature权限的应用程序可以启用/禁用或擦除GSI安装。这意味着只有可信的系统级应用程序才能与DSU一起工作。</p>

<p>为了确保原始用户数据得到保护，谷歌在Android Q中添加了一个名为“<strong>检查点</strong>的<a href="https://android.googlesource.com/platform/system/vold/+/master/Checkpoint.cpp">额外保护机制</a>，该功能通过将检查点分区恢复到原始状态来防止用户数据被破坏。然而，检查站不仅对DSU有用。它们还用于防止拙劣的<a href="https://www.xda-developers.com/android-q-project-mainline-security/">项目主线</a> APEX模块和<a href="https://android.googlesource.com/platform/system/vold/+/d3992498556fb1dce783d9d5e59f38cad492a6c3"> A/B </a> OTA更新。(<a href="https://www.xda-developers.com/how-a-b-partitions-and-seamless-updates-affect-custom-development-on-xda/">带有A/B分区</a>的设备已经有回滚保护，但是这些回滚需要工厂数据重置，而用户数据检查点则不需要。)</p>

<h3 id="installing-a-gsi">安装GSI</h3>
<p>如果你的设备像Pixel 3系列一样支持DSU，那么安装GSI就很容易了。首先，您必须确保通过以下两种方式之一启用动态系统功能标志:</p>

<ol> <li>如果您使用的是用户调试版本，请在设置&gt;系统&gt;开发选项&gt;功能标志中启用settings_dynamic_android标志。</li> <li>如果您使用的是用户版本，运行以下adb shell命令:<pre> <code class="hljs css"><span class="hljs-selector-tag">setprop</span> <span class="hljs-selector-tag">persist</span><span class="hljs-selector-class">.sys</span><span class="hljs-selector-class">.fflag</span><span class="hljs-selector-class">.override</span><span class="hljs-selector-class">.settings_dynamic_system</span> 1</code> </pre></li> </ol>

<p>然后，从谷歌或你设备的原始设备制造商那里下载最新的安卓Q测试版GSI。(DSU只允许安装由谷歌或原始设备制造商签名的GSI。)下载后，使用<a href="https://github.com/anestisb/android-simg2img"> simg2img </a>将稀疏图像转换为原始图像。使用gzip打包原始映像，然后将生成的归档文件复制到设备外部存储(例如/data/media/0/Download)或实际外部存储介质(如物理SD卡)上的某个位置。最后，以正确的意图启动DynamicSystemInstallationService应用程序，开始安装:</p>

<pre> <code class="hljs sql">adb shell am <span class="hljs-keyword">start</span>-activity \ -n com.android.dynsystem/com.android.dynsystem.VerificationActivity \ -a android.os.image.action.START_INSTALL \ -d <span class="hljs-keyword">file</span>:///<span class="hljs-keyword">storage</span>/emulated/<span class="hljs-number">0</span>/Download/system_raw.gz \ </code> </pre>




<p>一旦你点击重启，你将启动到GSI。该设备在GSI的可用性取决于您的设备的OEM厂商实施Treble的情况如何(或者说，他们违反Treble兼容性的程度有多低)。)有些设备使用GSIs会比其他设备更好，但一般来说，不要指望将此安装用作日常驱动程序。你应该测试你的应用程序，然后通过重启退出。如果您想留在GSI安装中进行进一步的测试，那么您可以使用<a href="https://android.googlesource.com/platform/system/gsid/+/refs/heads/master/gsi_tool.cpp"> gsi_tool </a> shell命令。</p>

<p>DSU的完整GSI安装说明可以在<a href="https://developer.android.com/topic/dsu#using-dsu">这里</a>找到。bug可以在<a href="https://issuetracker.google.com/issues?q=componentid:470386%2B"> Google Issue Tracker、</a> <a href="https://www.reddit.com/user/AndroidGSI"> Reddit </a>或者<a href="https://stackoverflow.com/questions/55841972/getting-started-with-gsi"> Stack Overflow </a>上归档。</p>

<h3 id="the-reason-behind-dynamic-system-updates">动态系统更新背后的原因</h3>
<p>当我与谷歌I/O的Iliyan Malchev交谈时，他重申了Treble团队的Hung-ying Tyan在11月的Android开发峰会上关于早期GSI接入的讲话。谷歌让DSU去<strong>尽可能广泛地征集反馈</strong>。目标是提高GSI的质量，反过来<strong>也会提高未来安卓版本的质量</strong>，因为GSI是最纯粹的安卓形式。谷歌是目前唯一一家测试下一版本GSI兼容性的公司(例如，Android Q系统映像在Android P供应商实现上的工作效果如何)，但随着越来越多的人使用GSI并提供反馈，原始设备制造商可以修复三重兼容性违规，因此GSI在未来会工作得更好。Iliyan表示，原始设备制造商和高通这样的供应商对在下一版本的系统映像中重用以前Android版本的供应商映像非常感兴趣。像DSU这样的倡议帮助谷歌和原始设备制造商填补了像VTS和CTS-on-GSI这样的自动化测试的覆盖缺口。因此，谷歌让更多的测试人员对下一个Android版本给出反馈，同时也听到关于三重兼容性违规的消息，以便OEM可以改进他们的工作。</p>

<p>Android Q中添加的动态系统更新是受欢迎的，但它不会是你们一些人所希望的双引导解决方案。如前所述，只有谷歌或原始设备制造商签署的系统镜像可以安装。当我问Iliyan关于扩展DSU以支持替代Android系统的生态系统的可能性时，他说这在技术上是可行的，因为DSU只是一个提供系统映像的渠道。任何原始设备制造商都可以使用它，只要最终结果是Android兼容的。谷歌还没有创造出OTA系统的替代品，DSU也不打算用于真正的双引导。无论如何，谷歌在Treble上所做的工作正在使Android更加模块化，所以如果原生双引导在未来成为现实，我不会感到惊讶。</p>

 </div>


</div>    
</body>
</html>