<html>
<head>
<title>Android 7.1+ has a "Panic Detection" Mode that Detects Frantic Back Button Presses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Android 7.1+有一个“恐慌检测”模式，可以检测疯狂的后退按钮按压</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/android-7-1-has-a-panic-detection-mode-that-detects-frantic-back-button-presses/#0001-01-01">https://www.xda-developers.com/android-7-1-has-a-panic-detection-mode-that-detects-frantic-back-button-presses/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>虽然像我们这样的以Android为中心的网站的许多读者不太可能遇到流氓应用程序危害他们系统的情况，但对于一般人来说可能不是这样。几乎每周我们都会从各种安全研究人员那里听到针对Android用户的新恶意软件。大多数这些恶意攻击可以通过检查权限或避免安装外观粗糙的应用程序来避免，尽管我们确实建议我们的读者将手机的安全掌握在自己手中，但谷歌有责任保护每一部Android手机。为此，该公司悄悄在Android 7.1牛轧糖中引入了一个新的安全功能，名为“<strong>恐慌检测</strong>”，它会连续监听多次后退按钮，然后将用户返回到他们的主屏幕。</p>

  
<p>很简单，如果一个流氓应用程序试图劫持用户的屏幕并阻止用户离开(也许是通过实现一个可访问性服务来拦截所有的按键事件)，Android将自己覆盖该应用程序以带回主屏幕。然后，用户可能会从启动器中卸载恶意应用程序。</p>

<p>这一功能没有被发现，这是可以理解的，因为谷歌可能不想向世界宣传他们正在摧毁恶意应用程序的一种方式。但是快速浏览一下Android的开源代码就会发现这个简单的功能是如何在支持它的设备上工作的。</p>

<hr/>

<h3 id="examining-the-code">检查代码</h3>
<p>首先，你的设备运行的是Android 7.1+并不代表实际上启用了这种恐慌检测行为。确定该功能是否开启的值可以在SystemUI APK的<code>config.xml</code>文件中找到。</p>

<pre> <code class="hljs xml"><br/>0 - Nothing<br/>1 - Go to home<br/><br/><span class="hljs-tag">&lt;<span class="hljs-name">integer</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"config_backPanicBehavior"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span></code> </pre>
<p>默认情况下，Android对紧急按下后退按钮的反应是什么都不做。然而，如果整数值<code>config_backPanicBehavior</code>被设置为1，这就是Android新的保护措施发挥作用的地方。</p>

<p> </p>

<p>在<code>PhoneWindowManager.java</code>中，我们可以看到这个特性是如何实现的。首先，该文件定义了两件事:系统需要按多少次后退按钮才能确定用户“惊慌失措”，然后根据这种状态采取什么行动。</p>

<pre> <code class="hljs java"><br/><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PANIC_PRESS_BACK_COUNT = <span class="hljs-number">4</span>;<br/><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PANIC_PRESS_BACK_NOTHING = <span class="hljs-number">0</span>;<br/><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PANIC_PRESS_BACK_HOME = <span class="hljs-number">1</span>;</code> </pre>
<p>默认情况下，系统需要连续按4次后退按钮才能进入紧急模式。该函数是否使用整数值<code>PANIC_PRESS_BACK_NOTHING</code>或<code>PANIC_PRESS_BACK_HOME</code>取决于SystemUI APK内配置文件中的值。</p>

<p>无论该值如何，每次多次按下后退按钮都会被检查，以确定是否会被视为紧急按下。首先，系统拦截对<a href="https://developer.android.com/reference/android/view/KeyEvent.html#KEYCODE_BACK"> KEYCODE_BACK </a>键事件的按下，并检查系统是否设置为检查该键的多次按下或长时间按下。然后，系统检查是否应该将同一个KEYCODE_BACK键事件的向上按压传递给用户应用程序。</p>



<p>在<code>interceptBackKeyDown()</code>方法中，如果后退按键计数器在1和3之间，那么系统跳过多次按键检测超时，因为紧急检测需要至少4次按键才能采取任何行动。</p>



<p>接下来，一旦用户将手指从back键移开，触发了up事件，<code>interceptBackKeyUp</code>将back键计数器加1。然后，它将消息排队300毫秒。这样做的原因是因为系统在决定后退按钮的按下是否是多次按下事件的一部分时预留了300毫秒的延迟时间。如果是，那么用户可能会慌乱地按下按钮，因此系统不应该向用户应用程序发送按键事件。</p>



<p>300毫秒多次按压超时值存储在安全设置“<code>multi_press_timeout</code>”中，如下所示。</p>

<pre> <code class="hljs php">/**<br/>* The duration <span class="hljs-keyword">in</span> milliseconds between the first tap<span class="hljs-string">'s up event and the second tap'</span>s<br/>* down event for an interaction to be considered part of the same multi-press.<br/>* <span class="hljs-meta">@hide</span><br/>*/<br/><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MULTI_PRESS_TIMEOUT = <span class="hljs-string">"multi_press_timeout"</span>;</code> </pre>
<p>默认情况下，该值设置为300毫秒。</p>

<pre> <code class="hljs php">/**<br/>* Defines the <span class="hljs-keyword">default</span> duration <span class="hljs-keyword">in</span> milliseconds between the first tap<span class="hljs-string">'s up event and the second</span><br/>* tap's down event for an interaction to be considered part of the same multi-press.<br/>*/<br/><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_MULTI_PRESS_TIMEOUT = <span class="hljs-number">300</span></code> </pre>
<p>然后，如果确实检测到多次按压(在300毫秒内超过1次后退按钮完成向上/向下按压)，系统调用<code>backMultiPressAction</code>方法来确定采取什么动作。最后，返回按钮计数器被重置为0。</p>





<p>虽然这是一个非常小的、未公开的功能，但仍然很高兴看到谷歌正在幕后做些什么，以使Android对普通用户来说更加安全。</p>

 </div>


</div>    
</body>
</html>