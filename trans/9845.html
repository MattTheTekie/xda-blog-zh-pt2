<html>
<head>
<title>How an Anime Game's Root Detection led to the discovery of a Security Vulnerability in phones from LG, OnePlus, Huawei, Xiaomi, and others</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translatedd">一个动漫游戏的根检测是如何导致LG、一加、华为、小米等公司的手机发现安全漏洞的</h1>
<blockquote class="translatedd">原文：<a href="https://www.xda-developers.com/procfs-leak-lg-oneplus-huawei-xiaomi-asus/#0001-01-01">https://www.xda-developers.com/procfs-leak-lg-oneplus-huawei-xiaomi-asus/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p class="translatedd">普通消费者和技术爱好者每月在超过20亿台设备上使用移动Android操作系统。尽管与Android用户的总体人口相比，解锁引导加载程序并启动智能手机的人数相对较少，但在XDA和Reddit等论坛上仍有很多人。Magisk是修补社区不可或缺的工具。它提供无系统的root访问，并拥有MagiskHide等工具，使root用户能够继续使用他们喜欢的应用程序、游戏和服务，而不受限制。然而，一款流行的动漫游戏一直在巧妙地滥用一个系统安全漏洞来绕过Magisk的反root检测。这是如何工作的，以及哪些设备受到这个安全漏洞的影响。</p>

  
<ul> <li class="translatedd">一个游戏用一个bug来检测一个设备是否被rooted了。如果设备是根用户，游戏会阻止用户玩游戏。</li> <li class="translatedd">该漏洞允许一个应用程序读取内存中其他应用程序的状态，而不需要任何特殊权限。该漏洞不允许应用程序从其他应用程序窃取任何数据。这种小毛病并不严重，而且相当无害。</li> <li class="translatedd">谷歌已经意识到这个问题，并更新了他们的测试工具，以确保所有设备都得到保护。</li> </ul>


<h2 id="background" class="translatedd">背景</h2>
<p class="translatedd">一个叫做命运/大秩序的流行动漫游戏阻止了根用户尝试玩这个游戏。XDA认出了开发者<a href="https://forum.xda-developers.com/member.php?u=4470081"> topjohnwu </a>，Magisk的首席开发者，之前<a href="https://www.xda-developers.com/fate-grand-order-fortnite-mobile-magisk/">发现了绕过Fate/Grand Order的根检测的方法</a>，但是尽管他尽了最大努力，他的解决方案在他的OnePlus 6上并不起作用。这位开发人员决心不放弃，他分析了Fate/Grand Order来弄清楚它是如何在他的一加设备上检测到root的。正如他在他的<a href="https://medium.com/@topjohnwu/from-anime-game-to-android-system-security-vulnerability-9b955a182f20">媒体帖子</a>中解释的那样，这让他发现了一个安全漏洞，Fate/Grand Order似乎正在滥用这个漏洞来继续检测一加设备上的root访问。</p>

 


<p class="ad-odd translatedd"> </p>


<h2 id="procfs-and-android" class="translatedd">Procfs和Android</h2>
<p class="translatedd">在基于Unix的操作系统上，有一个称为“procfs”的特殊文件系统，它包含进程(比如应用程序)的信息，比如它们的内存使用情况(比如RAM)、状态(进程是否正在运行、是否处于睡眠状态等等。).在大多数基于Unix的操作系统上，用户和应用程序可以很容易地访问procfs，以查看他们的系统上正在运行什么类型的应用程序和服务(就像Window的任务管理器一样)。)然而，谷歌从Android 7.0牛轧糖开始<a href="https://issuetracker.google.com/issues/37091475">锁定对procfs </a>的访问。在Android Nougat之前，SystemPanel等应用程序可以收集正在运行的应用程序的数据，而不需要任何特殊权限。在Android Nougat之后，应用程序需要使用像<a href="https://developer.android.com/reference/android/app/usage/UsageStats"> UsageStats </a>或<a href="https://developer.android.com/reference/android/accessibilityservice/AccessibilityService"> AccessibilityService </a>这样的API，这两者都受到权限的限制，必须由用户授予权限。</p>

 



<p class="translatedd">Google通过使用标志“hidepid=2”挂载/proc来防止应用程序通过procfs读取其他应用程序的状态。通过使用hidepid=2挂载procfs，应用程序只能看到自己进程的状态。因此，应用程序需要使用UsageStats或AccessibilityService等公认的API来获取设备上正在运行的应用程序和服务的信息。</p>
<p class="ad-even translatedd"> </p>


<h2 id="vulnerability" class="translatedd">弱点</h2>
<p class="translatedd">如果procfs没有挂载hidepid=2怎么办？那么，应用程序将能够自由地读取系统上运行的其他应用程序(和挂载点)的状态，而不需要任何额外的权限*。Google在自己的设备上挂载hidepid=2的procfs，但是他们不会在其他厂商的设备上强制执行这个要求。LG、一加、华为/Honor、小米和其他公司的几款设备尚未安装hidepid=2的procfs，这是Fate/Grand Order等应用程序用来检测Magisk是否存在于设备上的功能。</p>

<p class="translatedd">* Android 9 Pie中的一个安全变化阻止了应用程序读取自己的“SELinux上下文”之外的信息，因为每个应用程序现在都是单独隔离的。SELinux是一个内核模块，充当某种看门人的角色，阻止应用程序和服务访问它们不应该访问的文件。SELinux上下文就像一个文件的标签，其中包含用户和角色等信息。如果没有为procfs启用hidepid=2标志，具有相同SELinux上下文的应用程序可以读取相同上下文中其他应用程序的信息。在运行Android 9 Pie的设备上，只有针对Android Pie构建的应用程序才会应用Android Pie的新SELinux更改。以Android 8.1 Oreo或更低版本为目标的应用程序将使用旧的SELinux规则，允许它们在相同的SELinux上下文中访问有关进程的信息，只要procfs安装时没有hidepid=2。由于新的Google Play要求，在你的设备上运行的大多数应用程序至少应该针对Android 8.0 Oreo，但许多应用程序还没有更新到针对Android Pie。</p>





<p class="translatedd">下面的截图显示了不挂载hidepid=2的procfs的后果。</p>




<p class="ad-odd translatedd"> </p>


<h2 id="how-bad-is-this" class="translatedd">这有多糟糕？</h2>
<p class="translatedd">如果我们将这个系统漏洞与类似<a href="https://www.xda-developers.com/nvidia-tegra-x1-google-pixel-c-nvidia-shield/">【fuseégelée】</a><a href="https://www.xda-developers.com/bluetooth-vulnerability-blueborne-impacts-android-ios-windows-and-linux-devices/">blue borne</a><a href="https://www.xda-developers.com/wpa2-wifi-protocol-vulnerability-krack/">KRACK</a>和<a href="https://www.xda-developers.com/chromebook-meltdown-spectre-how-to-check/"> Meltdown/Spectre </a>的漏洞进行比较，那么这个bug相比之下就相形见绌了。<strong>应用程序无法利用这一点获得root访问权限或窃取您的密码。您的银行账户和信用卡都很安全。一个应用程序所能做的最糟糕的事情就是判断另一个应用程序是否正在你的设备上运行，这种用途非常有限。请记住，这是许多GNU/Linux发行版的标准行为，Google只是最近才开始用Android Nougat阻止对procfs的访问。这个bug允许应用程序绕过需要某些权限来监控其他进程，但它们仍然无法打破Android的沙箱，并从其他应用程序中窃取数据。无论如何，这是无意的行为，破坏了Android的隐私功能，因此必须修复。</strong></p>
<p class="ad-even translatedd"> </p>


<h2 id="is-my-device-affected" class="translatedd">我的设备受到影响了吗？</h2>
<p class="translatedd">以下是我们发现的无法使用hidepid=2挂载procfs的设备列表:</p>

<div class="table-container"><table border="1" cellpadding="1" cellspacing="1"><thead><tr><th><p class="translatedd">设备原产商</p> </th><th><p class="translatedd">设备</p> </th><th><p class="translatedd">安卓版本</p> </th><th><p class="translatedd">procfs泄漏</p> </th> </tr></thead><tbody><tr><td><p class="translatedd">华硕</p> </td><td><p class="translatedd translated">ZenFone 5Z</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">黑莓</p> </td><td><p class="translatedd">按键2</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">必要的</p> </td><td><p class="translatedd translated">PH-1</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">谷歌</p> </td><td><p class="translatedd">像素2</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">谷歌</p> </td><td><p class="translatedd">像素3</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">谷歌</p> </td><td><p class="translatedd">像素3 XL</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">荣耀</p> </td><td><p class="translatedd">魔法2</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">常简称为HTC或宏达电</p> </td><td><p class="translatedd translated">U12+</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">华为</p> </td><td><p class="translatedd translated">Mate 20 X</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">水平规ˌ水准仪(Level Gauge)</p> </td><td><p class="translatedd translated">G7 ThinQ</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">水平规ˌ水准仪(Level Gauge)</p> </td><td><p class="translatedd translated">V40 ThinQ</p> </td><td><p class="translatedd">安卓8.1奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">摩托罗拉</p> </td><td><p class="translatedd translated">Moto G4</p> </td><td><p class="translatedd">安卓8.1奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">诺基亚（总部设在芬兰）</p> </td><td><p class="translatedd">7.1</p> </td><td><p class="translatedd">安卓8.1奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">一加</p> </td><td><p class="translatedd">6</p> </td><td><p class="translatedd">安卓8.1奥利奥/安卓9派</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">一加</p> </td><td><p class="translatedd translated">6T</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">雷蛇</p> </td><td><p class="translatedd">电话2</p> </td><td><p class="translatedd">安卓8.1奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd translated">Galaxy Note 8</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd translated">Galaxy Note 9</p> </td><td><p class="translatedd">安卓8.1奥利奥/安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd">银河S7</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd">银河S8</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd">银河S9</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">三星电子</p> </td><td><p class="translatedd translated">Galaxy S9+ (Exynos)</p> </td><td><p class="translatedd">安卓8.0奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">索尼</p> </td><td><p class="translatedd translated">Xperia XZ1</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">不</p> </td> </tr><tr><td><p class="translatedd">小米</p> </td><td><p class="translatedd">米Mix 2S</p> </td><td><p class="translatedd">安卓9派</p> </td><td><p class="translatedd">是</p> </td> </tr><tr><td><p class="translatedd">小米</p> </td><td><p class="translatedd translated">POCO F1</p> </td><td><p class="translatedd">安卓8.1奥利奥</p> </td><td><p class="translatedd">是</p> </td> </tr></tbody> </table> </div><p class="ad-odd translatedd"> </p>


<h2 id="how-to-check-if-your-device-is-affected" class="translatedd">如何检查您的设备是否受到影响</h2>
<p class="translatedd">很容易检查您的设备是否向其他应用程序泄漏了进程信息(换句话说，procfs没有使用hidepid=2挂载)。虽然您可以像我们一样使用shell命令，但是您也可以使用topjohnwu开发的应用程序进行检查。如果你的手机是rooted的，他的应用程序还允许你用hidepid=2重新安装procfs。</p>





<p/><p class="translatedd"><a href="https://github.com/topjohnwu/ProcGate/releases"> <strong>下载ProcGate </strong> </a></p>
<p class="ad-even translatedd"> </p>


<h2 id="will-there-be-a-fix" class="translatedd">会有解决办法吗？</h2>
<p class="translatedd"><strong>是的，这个问题会在</strong>解决。Google现在将要求所有设备安装hidepid=2的procfs。他们将通过<a href="https://android-review.googlesource.com/c/platform/cts/+/833984">更新</a>兼容性测试套件(CTS)来加强这一点，所有设备都必须通过一系列测试才能使用Google Play应用和服务。所有OEM厂商(希望销售预装了谷歌Play商店的设备)必须在不久的将来发布一个更新来重新安装hidepid=2的procfs。由于一加设备是第一个发现此问题的设备，<strong>一加已经意识到此问题，并正在努力解决</strong>。如果其他OEM对这个错误发表评论，我们会更新这篇文章，但没有必要怀疑您的设备的OEM是否会发布更新。如果他们希望他们的更新通过CTS，那么他们必须修复这个bug。</p>

 </div>


</div>    
</body>
</html>