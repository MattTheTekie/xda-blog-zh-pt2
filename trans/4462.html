<html>
<head>
<title>Exploit Targets Qualcomm's EDL Mode, Affects Some Xiaomi, OnePlus, Nokia and other Devices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>漏洞攻击针对高通的EDL模式，影响了小米、一加、诺基亚和其他设备</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/exploit-qualcomm-edl-xiaomi-oneplus-nokia/#0001-01-01">https://www.xda-developers.com/exploit-qualcomm-edl-xiaomi-oneplus-nokia/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>采用高通芯片组的设备有一个主<strong>P</strong>B<strong>T3】oot<strong>l</strong>loader(PBL ),它通常引导Android系统，但也包含一种称为EDL模式的替代引导模式。EDL模式是高通的紧急下载模式，允许原始设备制造商(OEM)在设备上强制安装flash软件。这不能修改(只读模式)，并且对设备的存储具有完全控制权。包括一加和小米在内的许多原始设备制造商已经发布了利用EDL模式和一种称为Firehose的协议来解锁设备的工具(称为程序员)，而诺基亚等公司的其他工具已经泄露。Firehose可以利用许多命令来刷新设备，并能够检查设备内存中的数据。来自<em> Aleph Research </em>的安全研究人员<a href="https://alephsecurity.com/authors/roeeh">Roee Hay</a>(<a href="https://twitter.com/roeehay">@ roe Hay</a>)和<a href="https://alephsecurity.com/authors/noamh"> Noam Hadad </a>发现了使用这种模式的关键设备漏洞，这实际上授予了攻击者<strong>完全访问设备的权限</strong>。</strong></p>

  
<p>值得注意的是<strong>这种利用需要物理接触设备，但它仍然非常危险，很可能无法修补</strong>。攻击者利用授予EDL模式的访问级别绕过诺基亚6的安全启动，击败了信任链，并获得了启动序列每个部分的完整代码执行，包括Android操作系统本身。从理论上讲，它在其他设备上也可以以同样的方式工作，研究人员还成功解锁并根接了多个小米设备，而没有任何数据丢失。</p>

 
<h2 id="what-devices-are-affected-by-this-exploit">这种利用会影响哪些设备？</h2>
<p>首先是受影响的设备。</p>

<section class="emaki-custom-block emaki-custom-expandable"><div class="emaki-custom expandable" id="custom_block_4"><h3 id="list-of-devices-affected">受影响的设备列表。</h3><ul> <li>LG G4</li> <li>诺基亚6 (d1c)</li> <li>诺基亚c5</li> <li>Nexus 6 (shamu)</li> <li>Nexus 6P(钓鱼)</li> <li>G4 Plus摩托车</li> <li>OnePlus 5(芝士汉堡)</li> <li>OnePlus 3T</li> <li>一加3</li> <li>一加2</li> <li>OnePlus X</li> <li>一加一</li> <li>中兴Axon天机7</li> <li>ZUK Z1</li> <li>ZUK Z2</li> <li>小米Note 5A (ugglite)</li> <li>小米Note 5 Prime (ugg)</li> <li>小米Note 4(美度)</li> <li>小米Note 3(杰森)</li> <li>小米Note 2(蝎子)</li> <li>小米Mix(锂)</li> <li>小米Mix 2 (chiron)</li> <li>小米Mi 6 (sagit)</li> <li>小米Mi 5s(摩羯座)</li> <li>小米米5s Plus(纳)</li> <li>小米Mi 5x(蒂芙尼)</li> <li>小米Mi 5(双子星)</li> <li>小米3(癌症)</li> <li>小米Mi A1(天梭)</li> <li>小米Mi Max2(氧气)</li> <li>小米红米Note 3 (kenzo)</li> <li>小米Redmi 5A (riva)</li> <li>小米红米4A(玫瑰色)</li> </ul> </div></section><p class="ad-odd"> </p>


<h2 id="exploiting-an-android-phone">利用安卓手机</h2>
<h3 id="the-boot-sequence-of-a-typical-android-qualcomm-phone">典型的安卓高通手机的启动顺序</h3>
<p>在解释如何利用它之前，首先理解典型Android设备的引导序列是很重要的。<strong> S </strong>软件<strong>B</strong>oot<strong>l</strong>loader(SBL)是一个数字签名的引导加载程序，在加载到imem之前会检查其真实性。imem是一种用于调试和DMA(<strong>d</strong>direct<strong>m</strong>emory<strong>a</strong>access)事务的快速片上存储器，为高通芯片组专有。</p>

<p>一些设备有一个e <strong> X </strong>可扩展<strong>B</strong>oot<strong>l</strong>loader(XBL)而不是SBL，但是引导过程几乎是一样的。SBL或XBL随后推出ABOOT，实现快速启动。随后，TrustZone(基于硬件的安全性)也被加载。TrustZone通过基于硬件的根证书来检查ABOOT的真实性。SBL(或XBL，在某些情况下)旨在拒绝错误签名(或未签名)的ABOOT。</p>

<p>一旦通过认证，ABOOT就会在启动Linux内核之前检查/boot和/recovery的真实性。一些系统准备工作已经完成，然后代码执行转移到内核。ABOOT通常被称为“Android Bootloader”，当我们解锁设备的Bootloader时，我们在ABOOT中禁用了这种真实性检查。</p>
<div class="body-img landscape"><div class="responsive-img image-expandable img-article-item" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;Boot sequence of a standard Android device visualised. \/\/ Source: &lt;a href=\&quot;https:\/\/alephsecurity.com\/2018\/01\/22\/qualcomm-edl-1\/?resub\&quot;&gt;Aleph Research&lt;\/a&gt;&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="1500px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png?q=50&amp;fit=crop&amp;w=1500&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="943px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png?q=50&amp;fit=crop&amp;w=943&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="767px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png?q=50&amp;fit=crop&amp;w=767&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="480px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png?q=50&amp;fit=crop&amp;w=480&amp;dpr=1.5"/> <img class="lazyload" alt="" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png" src="../Images/405d76652e351800a97446b2ad555582.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/Boot-sequence.png"/> </picture> <figcaption class="body-img-caption">Boot sequence of a standard Android device visualised. // Source: <a href="https://alephsecurity.com/2018/01/22/qualcomm-edl-1/?resub">Aleph Research</a></figcaption> </figure> </div>


 </div>


<h3 id="accessing-edl-mode">访问EDL模式</h3>
<p>虽然一些设备有简单的硬件组合(或者更糟糕的是，许多小米设备中都有简单的专有快速启动命令)，但其他设备，如诺基亚设备，需要短路设备主板上的“测试点”引脚。在2017年12月的安全补丁之前，在许多设备(包括Nexus 6和6P)上简单地运行“adb reboot edl”并进入edl模式也是可能的。这一问题已经得到解决。</p>
<div class="body-img landscape"><div class="responsive-img image-expandable img-article-item" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;Test points are shown in a drawn-on yellow box at the bottom of the device's mainboard. \/\/ Source: &lt;a href=\&quot;https:\/\/alephsecurity.com\/2018\/01\/22\/qualcomm-edl-1\/?resub\&quot;&gt;Aleph Research&lt;\/a&gt;&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="1500px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg?q=50&amp;fit=crop&amp;w=1500&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="943px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg?q=50&amp;fit=crop&amp;w=943&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="767px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg?q=50&amp;fit=crop&amp;w=767&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="480px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg?q=50&amp;fit=crop&amp;w=480&amp;dpr=1.5"/> <img class="lazyload" alt="" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg" src="../Images/691dbd0d99b927a3e383efe162874b1b.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/test_points_nokia_6.jpg"/> </picture> <figcaption class="body-img-caption">Test points are shown in a drawn-on yellow box at the bottom of the device's mainboard. // Source: <a href="https://alephsecurity.com/2018/01/22/qualcomm-edl-1/?resub">Aleph Research</a></figcaption> </figure> </div>


 </div>


<p>其他设备也可以使用所谓的“深闪”电缆，这是一种特殊的电缆，某些引脚被短路，以告诉系统转而启动到EDL模式。旧的小米设备可以利用这种方法，以及诺基亚5和诺基亚6。当其他设备无法验证SBL时，它们也将启动进入EDL模式。</p>
<div class="body-img landscape"><div class="responsive-img image-expandable img-article-item" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;A deep flash cable&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="1500px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg?q=50&amp;fit=crop&amp;w=1500&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="943px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg?q=50&amp;fit=crop&amp;w=943&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="767px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg?q=50&amp;fit=crop&amp;w=767&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="480px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg?q=50&amp;fit=crop&amp;w=480&amp;dpr=1.5"/> <img class="lazyload" alt="" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg" src="../Images/125cae069a61ac2270f5ff8a1d533012.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/01/MIUI-Deep-Flash-Cable.jpg"/> </picture> <figcaption class="body-img-caption">A deep flash cable</figcaption> </figure> </div>


 </div>


<h3 id="utilizing-edl-mode-to-gain-full-access-on-a-oneplus-3-3t">利用EDL模式在OnePlus 3/3T上获得完全访问权限</h3>
<p>EDL模式可以在设备上以多种方式使用，主要是通过强制刷新设备来解除设备锁定。如上所述，理论上任何人访问这种模式都是安全的，因为最坏的情况是ABOOT会拒绝未经制造商正式签名的软件。虽然这是真的，但在研究人员展示的概念证明中，完全控制OnePlus 3或3T及其文件实际上是可能的。</p>

<p>这将通过两个非常危险的命令来完成，一加在旧版本的ABOOT(Android boot loader)中保留了这两个命令，以便解锁设备的引导加载程序(引导时不向用户显示警告)并禁用dm_verity。dm_verity也称为验证启动，是Android设备上安全启动序列的一部分。这两个命令如下。</p>

<pre> <code class="hljs ">fastboot oem disable_dm_verity</code> </pre>
<pre> <code class="hljs ">fastboot oem 4F500301/2</code> </pre>
<p>观察下面简单的4步流程，该流程利用了消防软管协议。</p>

<ol> <li>首先，引导设备进入EDL模式。这可以通过OxygenOS 5.0或更低版本上的adb来完成，也可以通过使用简单的硬件组合键来完成。</li> <li>下载OxygenOS 4.0.2以下的旧系统镜像。</li> <li>通过firehose刷新aboot.bin(记住aboot.bin实现了快速启动，正如我们前面提到的)</li> <li>您现在可以禁用安全引导并解锁引导加载程序<strong>,而无需擦除设备</strong>,只需使用上面的两个快速引导命令。</li> </ol>

<p>如果你还记得，一加曾被发现在近一年前留下了两个危险的快速启动命令，一个解锁了引导装载程序，另一个禁用了安全启动。虽然攻击者<strong>确实无法在设备</strong>上安装恶意软件，但他们可以<strong>将设备</strong>降级，使<strong>变得更旧，更容易受到攻击软件</strong>的攻击。只需运行上述快速启动命令，攻击者就可以对设备拥有<strong>完全访问权</strong>。</p>

<p>就这样，引导加载程序解锁，安全引导关闭，绝对没有数据丢失。如果攻击者想更进一步，他们可以刷新一个恶意的自定义内核，允许用户以root用户身份访问设备，而用户永远不会知道。</p>

<p>Firehose通过高通撒哈拉协议工作，该协议接受OEM签名的程序员，这就是上述攻击将如何执行。当连接到设备时，它充当USB上的SBL。大多数程序员使用<em>消防软管</em>在EDL模式下与手机通信，这是研究人员用来获得完全设备控制的。研究人员还利用这一点<strong>简单地通过闪烁解锁引导加载程序的修改图像</strong>来解锁小米设备。然后，他们刷新了一个自定义内核，该内核提供了root访问权限，并在许可模式下启动SELinux，还从设备中提取了加密的用户数据映像。</p>
<p class="ad-even"> </p>


<h2 id="conclusion">结论</h2>
<p>不知道为什么原始设备制造商从高通释放这些程序员。诺基亚、LG、摩托罗拉和谷歌程序员泄露而不是被释放，然而研究人员通过类似的利用方法成功打破了诺基亚6的整个信任链，并获得了完全的设备访问权限。他们确信攻击可以被移植到任何支持这些程序员的设备上。如果可能的话，原始设备制造商应使用硬件qfse来防止软件回滚，方法是在设备硬件回滚时熔断，并警告用户回滚已经发生。感兴趣的人可以看看下面完整的研究论文，也可以阅读完整的诺基亚开发。</p>

<hr/>

<p><a href="https://alephsecurity.com/2018/01/22/qualcomm-edl-1/"> <strong>资料来源:Aleph Research </strong> </a></p>

 </div>


</div>    
</body>
</html>