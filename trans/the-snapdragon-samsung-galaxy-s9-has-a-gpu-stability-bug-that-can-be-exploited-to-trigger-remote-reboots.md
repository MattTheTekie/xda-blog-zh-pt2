# 骁龙三星 Galaxy S9 有一个 GPU 稳定性漏洞，可被利用来触发远程重启

> 原文：<https://www.xda-developers.com/the-snapdragon-samsung-galaxy-s9-has-a-gpu-stability-bug-that-can-be-exploited-to-trigger-remote-reboots/>

新的[三星 Galaxy S9](https://www.xda-developers.com/snapdragon-samsung-galaxy-s9-lineageos-15-1/) 包括几个市场的最新高通骁龙 845 片上系统，包括香港、美国、加拿大和拉丁美洲的部分地区。在一些市场，三星经常选择最新的旗舰产品高通骁龙 SoC，而不是他们自己的 Exynos SoC。在美国通常都是这样，三星 Galaxy S6 例外。对于普通消费者来说，Exynos 9810 和骁龙 845 的变体之间几乎没有区别。然而，实际上，芯片组的差异会导致截然不同的体验。

[*Anandtech*](https://www.anandtech.com/show/12520/the-galaxy-s9-review/12) 对骁龙 Galaxy S9 和 Exynos Galaxy S9 的评测揭示了这两款机型在性能和电池续航时间上的明显差异，骁龙机型轻松胜过 Exynos 机型。据一家名为 [*GraphicsFuzz*](http://www.graphicsfuzz.com/) 的英国公司称，由于这两种截然不同的芯片组，性能差异似乎不是这次唯一的担忧。 *GraphicsFuzz* 是一家初创公司，专门测试设备上 GPU 的可靠性。他们开发测试来寻找图形驱动程序中的错误，并帮助诊断他们发现的任何问题的根本原因。例如，该团队发现了一个影响三星 Galaxy S6 的 ARM 驱动程序的安全问题[，为此他们获得了谷歌的 bug 奖金。在他们对骁龙三星 Galaxy S9 的测试中， *GraphicsFuzz* 在 Adreno 630 的图形驱动程序中发现了一个错误，该错误允许他们在使用普通三星互联网浏览器浏览时**通过有效的 WebGL 互联网页面**触发整个手机重启。](https://bugs.chromium.org/p/chromium/issues/detail?id=675658)

特别是，Adreno 630 渲染复杂但有效的着色器时存在错误，可利用该错误使设备冻结，然后最终重新启动。着色器只是一个允许 GPU 渲染图像的程序。 *GraphicsFuzz* 并没有恶意设计 WebGL 页面来触发这个 bug，而是说是在他们对设备的 GPU 稳定性进行标准测试时偶然发现的。一旦他们发现这种远程崩溃是可复制的，该公司就联系了 *XDA 开发商*，以促进高通和三星的披露过程。

## 骁龙三星 Galaxy S9 上的 WebGL 崩溃再现

在我们联系两家公司的代表之前，我们在自己的设备上验证了 *GraphicsFuzz* 的发现。 *GraphicsFuzz* 建立了一个特殊的网页供我们测试，我们选择了谷歌 Play 商店最受欢迎的 5 个互联网浏览器，看看会发生什么。下表显示了在 5 种不同的 web 浏览器上渲染复杂着色器的效果。

**被测设备:**高通骁龙 845 三星 Galaxy S9+ (SM-G965U)

**操作系统:**安卓 8.0.0 奥利奥 SM-G965U

| 

网络浏览器

 | 

结果

 |
| 谷歌浏览器 v65.0.3325.109 | 仅冻结约 2 秒钟 |
| 三星互联网版本 7.0.10.46 | 冻结，然后最终触发完全重启 |
| Opera v45.1 版。56866.88868888686 | 冻结电话 |
| 微软 Edge 1 . 0 . 0 . 1726 版 | 仅冻结约 3 秒钟 |
| Firefox v59.0.2 | 浏览器崩溃 |

谷歌 Chrome 和微软 Edge 都会冻结手机几秒钟，并产生一个 WebGL 错误，但设备最终会没事。 *GraphicsFuzz* 向我们报告说，他们已经与谷歌 Chrome 团队讨论了一段时间，并了解到 Chrome 实现了一种机制，在设定的一段时间后结束 GPU 进程，以防止手机完全崩溃。Opera 会冻结手机，但不会触发重启。火狐应用程序本身崩溃，但手机没事。最后，通过三星互联网访问该页面会导致手机在完全重启前变慢。

以下是事故的视频演示:

## 错误的详细解释

*GraphicsFuzz* 进行了更深入的调查，表明导致手机重启的问题在于高通 Adreno 630 的 GPU 驱动程序，该驱动程序是高通骁龙 845 片上系统的一部分。 *GraphicsFuzz* 收集了一份关于此次事故的日志，我们将它嵌入到了下面。简单总结一下，当手机渲染复杂的着色器时，GPU 会设置一个叫做“栅栏”的东西。栅栏用于协调 CPU 和 GPU 之间对共享内存的访问。与台式机不同，移动 GPU 可以访问与 CPU 相同的 RAM，因此当玩游戏或渲染其他东西时，它会使用栅栏来访问共享内存。在有独立显卡的设备上，GPU 本身有自己的内存。所有当前的移动电话都与 RAM 的闪存共享视频存储器和随机存取存储器。这里的问题是围栏无法完成，这将触发内核恐慌，并导致手机重启。

### 重启前完全内核崩溃

```
 [12681.035590]  [2:crtc_commit:117:  433] kgsl kgsl-3d0: |a6xx_snapshot_gmu| set FENCE to ALLOW mode:0
[12681.035839]  [2:crtc_commit:117:  433] kgsl kgsl-3d0: |kgsl_device_snapshot| snapshot created at pa 0x000000016e500000 size 927400
[12681.035993]  [0:  kworker/u16:5:27740] kgsl kgsl-3d0: |kgsl_snapshot_save_frozen_<wbr />objs| kgsl_snapshot_save_frozen_objs start
[12681.036085]  [2:crtc_commit:117:  433] Kernel panic - not syncing: !!!FENCE TIMEOUT
[12681.036156]  [2:crtc_commit:117:  433] CPU: 2 PID: 433 Comm: crtc_commit:117 Tainted: G        W       4.9.65-13087505 #1
[12681.036248]  [2:crtc_commit:117:  433] Hardware name: Samsung STARQLTE PROJECT Rev14 (DT)
[12681.036319]  [2:crtc_commit:117:  433] Call trace:
[12681.036368]  [2:crtc_commit:117:  433] [] dump_backtrace+0x0/0x248
[12681.036438]  [2:crtc_commit:117:  433] [] show_stack+0x18/0x28
[12681.036509]  [2:crtc_commit:117:  433] [] dump_stack+0x98/0xc0
[12681.036578]  [2:crtc_commit:117:  433] [] panic+0x1e0/0x44c
[12681.036646]  [2:crtc_commit:117:  433] [] sde_plane_wait_input_fence+<wbr />0x174/0x28c
[12681.036727]  [2:crtc_commit:117:  433] [] sde_crtc_atomic_flush+0x1c4/<wbr />0x5e8
[12681.036807]  [2:crtc_commit:117:  433] [] drm_atomic_helper_commit_<wbr />planes+0x19c/0x1fc
[12681.036891]  [2:crtc_commit:117:  433] [] complete_commit+0x74/0x6a4
[12681.036960]  [2:crtc_commit:117:  433] [] _msm_drm_commit_work_cb+0x48/<wbr />0x1c4
[12681.037038]  [2:crtc_commit:117:  433] [] kthread_worker_fn+0x78/0x194
[12681.037108]  [2:crtc_commit:117:  433] [] kthread+0xd8/0xf0
[12681.037172]  [2:crtc_commit:117:  433] [] ret_from_fork+0x10/0x20
[12681.037239]  [2:crtc_commit:117:  433] Kernel loaded at: 0x800a0000, offset from compile-time address 20000
[12681.037331]  [2:crtc_commit:117:  433] SMP: stopping secondary CPUs 
```

*GraphicsFuzz* 认为这个问题只发生在三星互联网浏览器上的原因是 GPU 看门狗的问题。有时，GPU 可能会在长时间运行的着色器上挂起，在这种情况下，浏览器或操作系统通常会有一个 GPU 看门狗来强制重启无响应的图形驱动程序。 *GraphicsFuzz* 测试着色器有几个 for 循环，可能会使渲染时间更长，但它仍然是一个有效的着色器。其他几个设备，包括 Exynos 9810 三星 Galaxy S9 和 Mali-G72 GPU，都可以渲染这个着色器。因此， *GraphicsFuzz* 的团队得出的结论是，这个错误是由于 Adreno 630 的 GPU 驱动程序故障造成的。

运行相同版本三星互联网浏览器的高通骁龙 835 adre no 540 GPU 的谷歌 Pixel 2 XL 也慢得像爬行一样——这意味着这个错误可能是高通 GPU 驱动程序渲染着色器和三星浏览器看门狗没有结束服务的问题。

希望高通能够诊断出导致重启的 GPU 驱动程序中的潜在问题，并尽快向三星提供修复的驱动程序。当然，此更新传播到最终用户可能还需要一段时间。与此同时，我们预计三星将对三星互联网浏览器进行更新，以缓解这一问题(至少防止它被网页利用)，与谷歌 Chrome 的行为相匹配。虽然这个问题已知会影响高通骁龙 845 三星 Galaxy S9/S9+，但它也可能会影响更多使用骁龙 845 的设备。

如果你有兴趣测试你自己的移动或桌面设备的 GPU 可靠性， *GraphicsFuzz* 的团队已经制作了一个 webapp 演示，允许你在你的设备上运行一些有效的着色器。点击此链接，您可以通过[进入该网页。](http://www.graphicsfuzz.com/benchmark/android-v1.html)

## 披露时间表

*   **2018 年 3 月 28 日** : *图形模糊*联系 *XDA 开发商*告知我们这个问题。XDA 的开发者在我们自己的三星 Galaxy S9+上重现了这个问题。
*   **2018 年 3 月 29 日** : *GraphicsFuzz* 获得了更多细节，并为高通和三星员工建立了专门的网页来重现该漏洞
*   **2018 年 3 月 30 日**:*XDA——开发者*向三星和高通提供了报告的全部细节。我们在高通的联系人回复我们说我们的信息已经收到。
*   **2018 年 4 月 2 日**:我们的三星联系人回复我们，确认我们的信息已收到。
*   **2018 年 4 月 4 日**:我们的三星联系人建议我们在三星的[安全报告](https://security.samsungmobile.com/securityReporting.smsb)页面进行报告。*XDA——开发者*提交了一份报告，一名三星工程师被指派负责该报告。