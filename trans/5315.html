<html>
<head>
<title>Xiaomi's Anti-Rollback Explained: How to avoid bricking your phone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>小米的防回滚解释:如何避免把手机砌砖</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/xiaomi-anti-rollback-protection-brick-phone/#0001-01-01">https://www.xda-developers.com/xiaomi-anti-rollback-protection-brick-phone/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>回到7月，小米<a href="https://www.xda-developers.com/miui-10-global-beta-eight-xiaomi-devices/">为8款小米设备推出了</a> MIUI 10全球测试版8.7.5。当用户在他们的小米红米Note 5 Pro上安装更新时，他们<a href="https://www.xda-developers.com/miui-10-global-beta-8-7-5-anti-rollback-downgrade-brick-redmi-note-5-pro/">不知不觉地闪现了一个启用了防回滚保护的版本</a>。不喜欢MIUI 10全球测试版的用户在尝试重装最新MIUI 9全球稳定ROM时发现了一个令人讨厌的惊喜:他们的手机被砖头砸了！这不是那种可以通过恢复TWRP备份、刷新新ROM或使用MiFlash恢复到工厂映像来修复的砖块。这是一个难以恢复的砖块，需要使用EDL模式来修复。但除非你有授权账户，否则无法使用EDL模式，因此许多用户除了将手机送到授权服务中心或付费使用某人的EDL账户外，别无选择。在这篇文章中，我们将解释你需要知道的关于小米新的防回滚保护的一切，这样你就可以避免砖砌你的新手机。</p>

 
<hr/>


<h2 id="why-does-xiaomi-require-long-bootloader-unlock-wait-times-edl-authorization-and-anti-rollback-protection">小米为什么要求bootloader解锁等待时间长，EDL授权，防回滚保护？</h2>
<p>中国电子巨头小米是印度最受欢迎的智能手机品牌，这得益于其广泛的预算和中档设备选择。像华为一样，小米也在中国本土市场销售大量智能手机。这些设备中有许多从未在中国以外销售过，但这并不能阻止人们进口它们。小米产品的非官方零售商已经在全球速卖通、Gearbest和其他许多网站上涌现，允许中国以外的任何人购买最新的小米产品。这给该公司带来了挑战，因为他们在中国设备上安装的名为“MIUI中国”的软件不包含Google Play服务、谷歌Play商店或除英语或普通话之外的其他语言。因此，任何从中国进口小米设备的人都不应该获得开箱即用的谷歌应用和服务。</p>

<p>然而，第三方零售商找到了解决这个问题的方法，这样他们就可以说服消费者，他们销售的小米设备带有“官方”MIUI全球ROM。零售商将批量购买小米设备，解锁引导加载程序，自行更改软件或闪存一个定制的ROM，如Xiaomi.eu(基于MIUI China的非官方ROM，但具有更多语言和功能)，然后出售设备。大多数消费者将无法知道他们运行的是非官方/修改过的软件，而是将他们遇到的更新不足或错误归咎于小米。更糟糕的是，一些零售商会故意捆绑恶意软件或广告软件，这样他们就可以赚点外快。小米的声誉正受到这种做法的严重损害，因为技术审查人员和消费者陷入了这些非官方零售商的计划，因此他们需要想出一种方法来阻止可疑的零售商批量销售改装设备。</p>

<p>一种解决方案是完全屏蔽bootloader解锁，这是华为最近采取的激烈举措<a href="https://www.xda-developers.com/xda-huawei-decision-stop-bootloader-unlocking/">。看到他们的品牌在发烧友中的成功，小米还没有阻止bootloader解锁。相反，他们实施了一些路障来保护用户免受恶意第三方零售商的行动。</a></p>

<h3 id="bootloader-unlock-wait-times">引导加载程序解锁等待时间</h3>
<p>首先，他们实现了引导加载程序解锁的等待期。小米设备，除了在Android One程序下运行股票Android的小米mi A1、小米Mi A2和小米Mi A2 Lite，都需要使用小米专有的Mi解锁工具来解锁引导加载程序。在发送您解锁引导加载程序的请求后，Mi Unlock会强制您等待，然后验证您的请求并解锁引导加载程序。在2018年初增加到15天之前，等待时间过去是3天，最近，在某些情况下，等待时间增加到30天或<a href="https://www.xda-developers.com/xiaomi-2-month-wait-unlock-bootloader/">高达60天</a>。(小米的新子品牌Poco，<a href="https://www.xda-developers.com/poco-f1-unlock-bootloader-3-days/">在收到社区反馈后，将等待时间</a>缩短至3天，尽管<a href="https://www.xda-developers.com/xiaomi-devices-poco-f1-long-bootloader-wait-times/">几乎所有其他人仍需等待很长时间</a>。)在引导加载程序解锁过程中增加等待时间在减慢第三方零售商的操作方面是有效的，但是对于想要解锁引导加载程序以使他们的设备、闪存定制rom和闪存定制内核根化的爱好者来说，这也是可以理解的令人烦恼的事情。</p>

<h3 id="edl-authorization">EDL授权</h3>
<p>接下来，该公司开始锁定他们设备上的EDL模式。EDL代表紧急下载模式，它是所有高通设备上的另一种引导模式，通常用于解锁你的设备。为了使用EDL模式，你需要找到一个被OEM(小米)授权在你的设备上使用的所谓的“程序员”。EDL模式<strong>非常强大</strong>和<strong>非常低级</strong>，它通常被服务中心用来维修设备。然而，EDL模式也被普遍用于在中国小米设备上闪存官方和修改后的MIUI Global ROMs，而无需解锁引导加载程序。实质上，EDL模式成为了第三方零售商绕过小米的另一种方式。小米不希望消费者购买安装了全球ROM的中国版硬件，所以他们做了两件事:如果设备不是全球版本，就无法启动全球ROM(警告消息“此MIUI不能安装在此设备上”)，以及除非你有授权的mi帐户，否则无法使用EDL模式。</p>





<p><strong>更新:</strong>我们有更多关于小米最近关于闪现区域外MIUI版本的限制的细节。如果你正在考虑进口小米智能手机或平板电脑，你真的应该<a href="https://www.xda-developers.com/flash-miui-global-locked-bootloader-xiaomi-brick/">通读这篇文章以策安全</a>！</p>

<h3 id="anti-rollback-protection">防回滚保护</h3>
<p>最后，他们针对最新的小米设备，在最新版本的MIUI中实现了防回滚保护。你可能听说过防回滚保护。谷歌<a href="https://www.xda-developers.com/android-oreo-rollback-protection/">在Android 8.0 Oreo中增加了对该功能的支持</a>，而<a href="https://www.xda-developers.com/android-pie-rollback-protection/">则强制要求使用Android Pie的设备使用</a>。谷歌的防回滚保护是Android Verified Boot 2.0(也称为Verified Boot)的一项功能，如果它检测到设备被降级到较旧的未经批准的软件版本，它会阻止设备启动。防回滚保护对于防止攻击者在易受攻击的设备上加载旧软件是必要的。谷歌和小米的实现最大的区别是，如果你解锁bootloader，谷歌的防回滚保护是禁用的，而小米的是不能禁用的。一旦你在小米设备上安装了启用防回滚保护的版本，就没有回头路可走了。例如，小米8和小米红米Note 5 Pro分别从MIUI 10中国8.9.6和MIUI 10全球测试版8.7.5开始启用防回滚保护。</p>
<div class="body-img portrait"><div class="responsive-img image-expandable img-article-item-portrait" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;List of devices which currently have anti-rollback protection enabled. Source: &lt;a href=\&quot;https:\/\/xiaomi.eu\/community\/threads\/miui-10-stable-release.46190\/\&quot;&gt;Xiaomi.eu&lt;\/a&gt;.&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="750px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png?q=50&amp;fit=crop&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="750px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png?q=50&amp;fit=crop&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="600px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png?q=50&amp;fit=crop&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="360px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png?q=50&amp;fit=crop&amp;dpr=1.5"/> <img class="lazyload" alt="Xiaomi Anti-rollback protection" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png" src="../Images/15170f036700aab4db35c9a23b4161a6.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Anti-rollback-Protection.png"/> </picture> <figcaption class="body-img-caption">List of devices which currently have anti-rollback protection enabled. Source: <a href="https://xiaomi.eu/community/threads/miui-10-stable-release.46190/">Xiaomi.eu</a>.</figcaption> </figure> </div>


 </div>


<p>反回滚保护将阻止任何未经授权的零售商利用旧版本MIUI中的漏洞，从而保护用户免受剥削。然而，它也让许多人措手不及，因为小米在事先没有通知用户的情况下将其推出到红米Note 5 Pro。由于TWRP没有任何检查来阻止用户安装旧的、未经授权的MIUI版本，许多人在从MIUI测试版rom降级到MIUI稳定版rom时意外地阻塞了他们的设备。所有目前支持的小米设备最终都将获得防回滚保护，因此，了解如何在降级前检查它以及如果启用了防回滚保护，你可以做什么是非常重要的。</p>

<hr/>
<p class="ad-odd"> </p>


<h2 id="how-to-check-for-anti-rollback-protection">如何检查防回滚保护</h2>
<p>当我们谈到防回滚保护防止设备启动旧的、不安全的软件时，我们说验证启动“检测”旧软件的存在。这种检测的工作原理是，验证的引导有一个回滚索引，该索引与要安装的映像的回滚索引进行比较。根据回滚索引的比较方式，将会发生以下情况:</p>

<ul> <li>如果当前回滚索引比要刷新的映像中的回滚索引小<strong/>，则<strong>映像将被刷新</strong>，<strong>当前回滚索引将增加</strong>以匹配新的回滚索引。</li> <li>如果当前回滚索引<strong>等于</strong>待刷新映像中的回滚索引，则<strong>映像将被刷新</strong>，<strong>回滚索引不变</strong>。</li> <li>如果当前回滚索引<strong>比要刷新的映像中的回滚索引</strong>大，那么<strong>映像将被拒绝</strong>如果你是通过快速启动<strong>或Mi闪存</strong>刷新。(TWRP在闪烁之前不检查回滚索引，这就是为什么几乎所有的砖块都是通过TWRP降级的结果。)</li> </ul>

<p>现在您对回滚索引有了更好的理解，下面介绍如何在您的设备上实际检查当前的回滚索引以及您想要刷新的映像。</p>

<h3 id="how-to-find-current-rollback-index">如何找到当前回滚索引</h3>
<ol> <li>重新启动到快速启动模式</li> <li>输入以下命令:<code>fastboot getvar anti</code></li> <li>如果输出为空，则防回滚功能尚未启用。如果在输出中得到一个数字，那么这就是当前的回滚索引。</li> </ol>
<div class="body-img landscape"><div class="responsive-img image-expandable img-article-item" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;Current anti-rollback index of the device is 4.&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="1500px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg?q=50&amp;fit=crop&amp;w=1500&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="943px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg?q=50&amp;fit=crop&amp;w=943&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="767px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg?q=50&amp;fit=crop&amp;w=767&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="480px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg?q=50&amp;fit=crop&amp;w=480&amp;dpr=1.5"/> <img class="lazyload" alt="Xiaomi Anti-rollback protection" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg" src="../Images/148d5ffb2ec1977284b932de15e58e32.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Xiaomi-Fastboot-Getvar-Anti-Example.jpg"/> </picture> <figcaption class="body-img-caption">Current anti-rollback index of the device is 4.</figcaption> </figure> </div>


 </div>


<h3 id="how-to-find-rollback-index-of-images">如何找到图像的回滚索引</h3>
<ol> <li>下载与您要安装的恢复ROM相当的“快速启动”ROM。恢复ROM的文件名中始终包含设备的市场名称，并以. zip结尾。快速启动ROM的文件名中始终包含设备的代码名称，并以. tar.gz结尾。</li> <li>从. tar.gz归档文件中提取flash-all.bat。7Zip可以轻松处理这个问题。</li> <li>在Notepad++之类的文本编辑器中打开flash-all.bat，并查找下面一行:<code>set CURRENT_ANTI_VER=#</code></li> <li>那个数字(#)就是你要闪的MIUI版本的回滚索引。如果该数字等于或大于您当前的回滚指数，那么在TWRP、Mi闪存等中闪存是安全的。如果这个数字小于你当前的回滚指数，那么不要通过TWRP刷新这个ROM。</li> </ol>
<div class="body-img landscape"><div class="responsive-img image-expandable img-article-item" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png" data-modal-id="single-image-modal" data-modal-container-id="single-image-modal-container" data-img-caption="&quot;Snippet from the flash-all script of a fastboot ROM&quot;">
 
<figure> <picture>  <source media="(min-width: 1024px)" sizes="1500px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png?q=50&amp;fit=crop&amp;w=1500&amp;dpr=1.5"/> <source media="(min-width: 768px)" sizes="943px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png?q=50&amp;fit=crop&amp;w=943&amp;dpr=1.5"/> <source media="(min-width: 481px)" sizes="767px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png?q=50&amp;fit=crop&amp;w=767&amp;dpr=1.5"/> <source media="(min-width: 0px)" sizes="480px" data-srcset="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png?q=50&amp;fit=crop&amp;w=480&amp;dpr=1.5"/> <img class="lazyload" alt="Xiaomi Anti-rollback protection" data-img-url="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png" src="../Images/f67910121e495283de222912fde1ec2b.png" data-original-src="https://static1.xdaimages.com/wordpress/wp-content/uploads/2018/09/Fastboot-Xiaomi-1024x183.png"/> </picture> <figcaption class="body-img-caption">Snippet from the flash-all script of a fastboot ROM</figcaption> </figure> </div>


 </div>


<p>只要在通过TWRP降级之前检查回滚索引，避免完全不可恢复的砖块应该很简单。为了安全起见，你应该坚持使用Mi Flash或fastboot来刷新MIUI ROMs，因为你的手机的引导程序有内置的保护功能，可以防止你降级到回滚指数更低的版本。</p>

<hr/>
<p class="ad-even"> </p>


<h2 id="how-does-anti-rollback-protection-affect-custom-roms">防回滚保护如何影响自定义rom？</h2>
<p>如果你计划不再闪烁MIUI，那么对你来说不会有太大的改变。如果你想闪一个AOSP ROM像LineageOS，Pixel Experience，Resurrection Remix，Carbon ROM等，您仍然需要通过Mi解锁来解锁引导程序，引导TWRP，然后刷新自定义ROM。唯一值得注意的区别是你如何通过快速启动安装TWRP。由于防回滚保护会阻止您刷新TWRP映像，因此您需要先刷新一个“虚拟”映像。虚拟映像是一个空文件，除了向引导加载程序发送命令之外没有其他用途，因此它知道以后可以接受其他闪存。(如果你看上一节的flash-all脚本，这其实是小米官方的做法。)或者，您可以“快速启动”TWRP映像，将TWRP映像移动到您设备的存储器中，然后从TWRP内部刷新TWRP映像。我不会提供任何一种方法的详细说明，因为我建议您访问您的设备的论坛，以获得特定于设备的说明。</p>

<p/><p><a href="https://forum.xda-developers.com/xiaomi"> <strong>所有小米设备的XDA论坛指数</strong> </a></p>

<p>然而，有一点需要注意。没有办法预先知道回滚索引是否由于更新的引导加载程序、调制解调器、供应商或其他分区而增加。请记住，定制rom通常只会更改系统和引导分区，但为了通过最新的安全补丁更新来确保您的设备真正安全，您偶尔需要刷新最新官方MIUI ROMs中包含的最新图像。定制rom的开发者在推荐你更新之前，必须手动检查这些版本的回滚索引——这样，如果你打算从AOSP ROM返回MIUI，你就会知道新的更新何时将你锁定在某些MIUI版本。</p>

<hr/>
<p class="ad-odd"> </p>


<h2 id="what-do-i-do-if-i-bricked-my-phone">如果我屏蔽了我的手机，我该怎么办？</h2>
<p>如果你通过触发反回滚保护来阻止你的手机，你的选择就很少了。</p>

<ol> <li>将您的设备送至授权服务中心进行维修。服务中心可以通过EDL模式恢复您的设备。</li> <li>希望有办法绕过EDL授权(本质上是一种利用)，这样你就可以用正确的程序员手动恢复你的设备。</li> </ol>

<p>正如你所看到的，通过触发反回滚保护来阻止你的手机不是闹着玩的。你真的需要小心之前，你闪存任何旧版本的MIUI。</p>

<hr/>
<p class="ad-even"> </p>


<h2 id="frequently-asked-questions-faqs">常见问题(FAQ)</h2>
<ol> <li>如果我不想将我的设备砖化，我应该避免什么？<ul> <li>不要刷新回滚指数低于您设备当前回滚指数的MIUI版本。请参见上面的说明。</li> <li>不要用锁定的bootloader在中国小米硬件上闪存官方MIUI全球ROM。</li> </ul> </li> <li>我还能安装自定义的AOSP rom、内核、Magisk、Xposed、Substratum、RISE和其他模块吗？</li> <li>我还能在MIUI全球稳定版、MIUI全球开发者版、MIUI中国稳定版和MIUI中国开发者版之间切换吗？<ul> <li>可以，但是在安装旧版本的MIUI之前，您需要比较回滚指数。</li> </ul> </li> <li>为什么小米不在你解锁bootloader的时候禁用防回滚保护？</li> <li>为什么小米会在触发防回滚保护的情况下硬砖你的手机，而谷歌不这么做？<ul> <li>这又是一个好问题。</li> </ul> </li> <li>小米为什么不显示标准的验证启动警告，向用户显示软件被篡改了？<ul> <li>你有这些伟大的问题！严肃地说，这一点可能有点道理，因为至少在某些设备上可以禁用这个闪屏-<a href="https://forum.xda-developers.com/z2-force/development/remove-bootloader-unlocked-warning-t3702353"/>。</li> </ul> </li> </ol>

<hr/>

<p><em>特别感谢XDA公认开发者<a href="https://forum.xda-developers.com/member.php?u=6084385"> yshalsager </a>和XDA初级成员<a href="https://forum.xda-developers.com/member.php?u=8229896"> franztesca </a>对本文的协助！</em></p>

 </div>


</div>    
</body>
</html>