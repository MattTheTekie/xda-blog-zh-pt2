# 小米的防回滚解释:如何避免把手机砌砖

> 原文：<https://www.xda-developers.com/xiaomi-anti-rollback-protection-brick-phone/>

回到 7 月，小米[为 8 款小米设备推出了](https://www.xda-developers.com/miui-10-global-beta-eight-xiaomi-devices/) MIUI 10 全球测试版 8.7.5。当用户在他们的小米红米 Note 5 Pro 上安装更新时，他们[不知不觉地闪现了一个启用了防回滚保护的版本](https://www.xda-developers.com/miui-10-global-beta-8-7-5-anti-rollback-downgrade-brick-redmi-note-5-pro/)。不喜欢 MIUI 10 全球测试版的用户在尝试重装最新 MIUI 9 全球稳定 ROM 时发现了一个令人讨厌的惊喜:他们的手机被砖头砸了！这不是那种可以通过恢复 TWRP 备份、刷新新 ROM 或使用 MiFlash 恢复到工厂映像来修复的砖块。这是一个难以恢复的砖块，需要使用 EDL 模式来修复。但除非你有授权账户，否则无法使用 EDL 模式，因此许多用户除了将手机送到授权服务中心或付费使用某人的 EDL 账户外，别无选择。在这篇文章中，我们将解释你需要知道的关于小米新的防回滚保护的一切，这样你就可以避免砖砌你的新手机。

* * *

## 小米为什么要求 bootloader 解锁等待时间长，EDL 授权，防回滚保护？

中国电子巨头小米是印度最受欢迎的智能手机品牌，这得益于其广泛的预算和中档设备选择。像华为一样，小米也在中国本土市场销售大量智能手机。这些设备中有许多从未在中国以外销售过，但这并不能阻止人们进口它们。小米产品的非官方零售商已经在全球速卖通、Gearbest 和其他许多网站上涌现，允许中国以外的任何人购买最新的小米产品。这给该公司带来了挑战，因为他们在中国设备上安装的名为“MIUI 中国”的软件不包含 Google Play 服务、谷歌 Play 商店或除英语或普通话之外的其他语言。因此，任何从中国进口小米设备的人都不应该获得开箱即用的谷歌应用和服务。

然而，第三方零售商找到了解决这个问题的方法，这样他们就可以说服消费者，他们销售的小米设备带有“官方”MIUI 全球 ROM。零售商将批量购买小米设备，解锁引导加载程序，自行更改软件或闪存一个定制的 ROM，如 Xiaomi.eu(基于 MIUI China 的非官方 ROM，但具有更多语言和功能)，然后出售设备。大多数消费者将无法知道他们运行的是非官方/修改过的软件，而是将他们遇到的更新不足或错误归咎于小米。更糟糕的是，一些零售商会故意捆绑恶意软件或广告软件，这样他们就可以赚点外快。小米的声誉正受到这种做法的严重损害，因为技术审查人员和消费者陷入了这些非官方零售商的计划，因此他们需要想出一种方法来阻止可疑的零售商批量销售改装设备。

一种解决方案是完全屏蔽 bootloader 解锁，这是华为最近采取的激烈举措[。看到他们的品牌在发烧友中的成功，小米还没有阻止 bootloader 解锁。相反，他们实施了一些路障来保护用户免受恶意第三方零售商的行动。](https://www.xda-developers.com/xda-huawei-decision-stop-bootloader-unlocking/)

### 引导加载程序解锁等待时间

首先，他们实现了引导加载程序解锁的等待期。小米设备，除了在 Android One 程序下运行股票 Android 的小米 mi A1、小米 Mi A2 和小米 Mi A2 Lite，都需要使用小米专有的 Mi 解锁工具来解锁引导加载程序。在发送您解锁引导加载程序的请求后，Mi Unlock 会强制您等待，然后验证您的请求并解锁引导加载程序。在 2018 年初增加到 15 天之前，等待时间过去是 3 天，最近，在某些情况下，等待时间增加到 30 天或[高达 60 天](https://www.xda-developers.com/xiaomi-2-month-wait-unlock-bootloader/)。(小米的新子品牌 Poco，[在收到社区反馈后，将等待时间](https://www.xda-developers.com/poco-f1-unlock-bootloader-3-days/)缩短至 3 天，尽管[几乎所有其他人仍需等待很长时间](https://www.xda-developers.com/xiaomi-devices-poco-f1-long-bootloader-wait-times/)。)在引导加载程序解锁过程中增加等待时间在减慢第三方零售商的操作方面是有效的，但是对于想要解锁引导加载程序以使他们的设备、闪存定制 rom 和闪存定制内核根化的爱好者来说，这也是可以理解的令人烦恼的事情。

### EDL 授权

接下来，该公司开始锁定他们设备上的 EDL 模式。EDL 代表紧急下载模式，它是所有高通设备上的另一种引导模式，通常用于解锁你的设备。为了使用 EDL 模式，你需要找到一个被 OEM(小米)授权在你的设备上使用的所谓的“程序员”。EDL 模式**非常强大**和**非常低级**，它通常被服务中心用来维修设备。然而，EDL 模式也被普遍用于在中国小米设备上闪存官方和修改后的 MIUI Global ROMs，而无需解锁引导加载程序。实质上，EDL 模式成为了第三方零售商绕过小米的另一种方式。小米不希望消费者购买安装了全球 ROM 的中国版硬件，所以他们做了两件事:如果设备不是全球版本，就无法启动全球 ROM(警告消息“此 MIUI 不能安装在此设备上”)，以及除非你有授权的 mi 帐户，否则无法使用 EDL 模式。

**更新:**我们有更多关于小米最近关于闪现区域外 MIUI 版本的限制的细节。如果你正在考虑进口小米智能手机或平板电脑，你真的应该[通读这篇文章以策安全](https://www.xda-developers.com/flash-miui-global-locked-bootloader-xiaomi-brick/)！

### 防回滚保护

最后，他们针对最新的小米设备，在最新版本的 MIUI 中实现了防回滚保护。你可能听说过防回滚保护。谷歌[在 Android 8.0 Oreo 中增加了对该功能的支持](https://www.xda-developers.com/android-oreo-rollback-protection/)，而[则强制要求使用 Android Pie 的设备使用](https://www.xda-developers.com/android-pie-rollback-protection/)。谷歌的防回滚保护是 Android Verified Boot 2.0(也称为 Verified Boot)的一项功能，如果它检测到设备被降级到较旧的未经批准的软件版本，它会阻止设备启动。防回滚保护对于防止攻击者在易受攻击的设备上加载旧软件是必要的。谷歌和小米的实现最大的区别是，如果你解锁 bootloader，谷歌的防回滚保护是禁用的，而小米的是不能禁用的。一旦你在小米设备上安装了启用防回滚保护的版本，就没有回头路可走了。例如，小米 8 和小米红米 Note 5 Pro 分别从 MIUI 10 中国 8.9.6 和 MIUI 10 全球测试版 8.7.5 开始启用防回滚保护。

 <picture>![Xiaomi Anti-rollback protection](img/15170f036700aab4db35c9a23b4161a6.png)</picture> 

List of devices which currently have anti-rollback protection enabled. Source: [Xiaomi.eu](https://xiaomi.eu/community/threads/miui-10-stable-release.46190/).

反回滚保护将阻止任何未经授权的零售商利用旧版本 MIUI 中的漏洞，从而保护用户免受剥削。然而，它也让许多人措手不及，因为小米在事先没有通知用户的情况下将其推出到红米 Note 5 Pro。由于 TWRP 没有任何检查来阻止用户安装旧的、未经授权的 MIUI 版本，许多人在从 MIUI 测试版 rom 降级到 MIUI 稳定版 rom 时意外地阻塞了他们的设备。所有目前支持的小米设备最终都将获得防回滚保护，因此，了解如何在降级前检查它以及如果启用了防回滚保护，你可以做什么是非常重要的。

* * *

## 如何检查防回滚保护

当我们谈到防回滚保护防止设备启动旧的、不安全的软件时，我们说验证启动“检测”旧软件的存在。这种检测的工作原理是，验证的引导有一个回滚索引，该索引与要安装的映像的回滚索引进行比较。根据回滚索引的比较方式，将会发生以下情况:

*   如果当前回滚索引比要刷新的映像中的回滚索引小**，则**映像将被刷新**，**当前回滚索引将增加**以匹配新的回滚索引。**
***   如果当前回滚索引**等于**待刷新映像中的回滚索引，则**映像将被刷新**，**回滚索引不变**。*   如果当前回滚索引**比要刷新的映像中的回滚索引**大，那么**映像将被拒绝**如果你是通过快速启动**或 Mi 闪存**刷新。(TWRP 在闪烁之前不检查回滚索引，这就是为什么几乎所有的砖块都是通过 TWRP 降级的结果。)**

 **现在您对回滚索引有了更好的理解，下面介绍如何在您的设备上实际检查当前的回滚索引以及您想要刷新的映像。

### 如何找到当前回滚索引

1.  重新启动到快速启动模式
2.  输入以下命令:`fastboot getvar anti`
3.  如果输出为空，则防回滚功能尚未启用。如果在输出中得到一个数字，那么这就是当前的回滚索引。

 <picture>![Xiaomi Anti-rollback protection](img/148d5ffb2ec1977284b932de15e58e32.png)</picture> 

Current anti-rollback index of the device is 4.

### 如何找到图像的回滚索引

1.  下载与您要安装的恢复 ROM 相当的“快速启动”ROM。恢复 ROM 的文件名中始终包含设备的市场名称，并以. zip 结尾。快速启动 ROM 的文件名中始终包含设备的代码名称，并以. tar.gz 结尾。
2.  从. tar.gz 归档文件中提取 flash-all.bat。7Zip 可以轻松处理这个问题。
3.  在 Notepad++之类的文本编辑器中打开 flash-all.bat，并查找下面一行:`set CURRENT_ANTI_VER=#`
4.  那个数字(#)就是你要闪的 MIUI 版本的回滚索引。如果该数字等于或大于您当前的回滚指数，那么在 TWRP、Mi 闪存等中闪存是安全的。如果这个数字小于你当前的回滚指数，那么不要通过 TWRP 刷新这个 ROM。

 <picture>![Xiaomi Anti-rollback protection](img/f67910121e495283de222912fde1ec2b.png)</picture> 

Snippet from the flash-all script of a fastboot ROM

只要在通过 TWRP 降级之前检查回滚索引，避免完全不可恢复的砖块应该很简单。为了安全起见，你应该坚持使用 Mi Flash 或 fastboot 来刷新 MIUI ROMs，因为你的手机的引导程序有内置的保护功能，可以防止你降级到回滚指数更低的版本。

* * *

## 防回滚保护如何影响自定义 rom？

如果你计划不再闪烁 MIUI，那么对你来说不会有太大的改变。如果你想闪一个 AOSP ROM 像 LineageOS，Pixel Experience，Resurrection Remix，Carbon ROM 等，您仍然需要通过 Mi 解锁来解锁引导程序，引导 TWRP，然后刷新自定义 ROM。唯一值得注意的区别是你如何通过快速启动安装 TWRP。由于防回滚保护会阻止您刷新 TWRP 映像，因此您需要先刷新一个“虚拟”映像。虚拟映像是一个空文件，除了向引导加载程序发送命令之外没有其他用途，因此它知道以后可以接受其他闪存。(如果你看上一节的 flash-all 脚本，这其实是小米官方的做法。)或者，您可以“快速启动”TWRP 映像，将 TWRP 映像移动到您设备的存储器中，然后从 TWRP 内部刷新 TWRP 映像。我不会提供任何一种方法的详细说明，因为我建议您访问您的设备的论坛，以获得特定于设备的说明。

[**所有小米设备的 XDA 论坛指数**](https://forum.xda-developers.com/xiaomi)

然而，有一点需要注意。没有办法预先知道回滚索引是否由于更新的引导加载程序、调制解调器、供应商或其他分区而增加。请记住，定制 rom 通常只会更改系统和引导分区，但为了通过最新的安全补丁更新来确保您的设备真正安全，您偶尔需要刷新最新官方 MIUI ROMs 中包含的最新图像。定制 rom 的开发者在推荐你更新之前，必须手动检查这些版本的回滚索引——这样，如果你打算从 AOSP ROM 返回 MIUI，你就会知道新的更新何时将你锁定在某些 MIUI 版本。

* * *

## 如果我屏蔽了我的手机，我该怎么办？

如果你通过触发反回滚保护来阻止你的手机，你的选择就很少了。

1.  将您的设备送至授权服务中心进行维修。服务中心可以通过 EDL 模式恢复您的设备。
2.  希望有办法绕过 EDL 授权(本质上是一种利用)，这样你就可以用正确的程序员手动恢复你的设备。

正如你所看到的，通过触发反回滚保护来阻止你的手机不是闹着玩的。你真的需要小心之前，你闪存任何旧版本的 MIUI。

* * *

## 常见问题(FAQ)

1.  如果我不想将我的设备砖化，我应该避免什么？
    *   不要刷新回滚指数低于您设备当前回滚指数的 MIUI 版本。请参见上面的说明。
    *   不要用锁定的 bootloader 在中国小米硬件上闪存官方 MIUI 全球 ROM。
2.  我还能安装自定义的 AOSP rom、内核、Magisk、Xposed、Substratum、RISE 和其他模块吗？
3.  我还能在 MIUI 全球稳定版、MIUI 全球开发者版、MIUI 中国稳定版和 MIUI 中国开发者版之间切换吗？
    *   可以，但是在安装旧版本的 MIUI 之前，您需要比较回滚指数。
4.  为什么小米不在你解锁 bootloader 的时候禁用防回滚保护？
5.  为什么小米会在触发防回滚保护的情况下硬砖你的手机，而谷歌不这么做？
    *   这又是一个好问题。
6.  小米为什么不显示标准的验证启动警告，向用户显示软件被篡改了？
    *   你有这些伟大的问题！严肃地说，这一点可能有点道理，因为至少在某些设备上可以禁用这个闪屏-。

* * *

*特别感谢 XDA 公认开发者 [yshalsager](https://forum.xda-developers.com/member.php?u=6084385) 和 XDA 初级成员 [franztesca](https://forum.xda-developers.com/member.php?u=8229896) 对本文的协助！***