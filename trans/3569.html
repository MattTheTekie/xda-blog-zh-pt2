<html>
<head>
<title>OnePlus 3/3T Bootloader Vulnerability Allows Changing of SELinux to Permissive Mode in Fastboot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>OnePlus 3/3T引导加载程序漏洞允许在快速引导中将SELinux更改为许可模式</h1>
<blockquote>原文：<a href="https://www.xda-developers.com/oneplus-33t-bootloader-vulnerability-allows-changing-of-selinux-to-permissive-mode-in-fastboot/#0001-01-01">https://www.xda-developers.com/oneplus-33t-bootloader-vulnerability-allows-changing-of-selinux-to-permissive-mode-in-fastboot/#0001-01-01</a></blockquote><div><div class="content-block-regular">
<p/><p>一加3和T2一加3T是你现在能买到的最好的手机。虽然即将到来的2017年旗舰尚未向消费者展示，但在他们缺席的情况下，<a href="https://www.xda-developers.com/dissecting-speed-how-oneplus-leveraged-excellent-real-world-performance/"> OnePlus 3/3T以实惠的价格主导了真实世界的性能</a>。</p>

  
<p><strong>但是，如果我们要公平地评估这款设备，</strong>我们需要承认，尽管一加尽了最大努力，OnePlus 3/3T也不是没有缺点。例如，我们之前报道过安全问题，比如当你在手机上检查更新时，<a href="https://www.xda-developers.com/be-warned-oneplus-is-still-leaking-your-imei-when-you-check-for-updates/" target="_blank">一加通过网络泄露了IMEI细节。现在，我们有另一个安全问题要添加到列表中，这个问题具有潜在的更危险的后果。</a></p>

<p>OnePlus 3/3T的引导加载程序中的漏洞为恶意攻击打开了大门。IBM X-Force应用程序安全研究团队的Roee Hay发现，IBM X-Force交换平台上的<a href="https://exchange.xforce.ibmcloud.com/collection/OnePlus-3-fastboot-oem-selinux-permissive-Vulnerability-d38d8557f1a01570539151c782d52aaf" target="_blank">显示，该漏洞允许攻击者操纵设备上的SELinux状态，从而将其切换到许可模式。所有攻击者需要的是<strong>物理访问</strong>设备，或者<strong>远程访问ADB连接</strong>设备。</a></p>

<p>安全增强的Linux是一个Linux内核安全模块，允许访问和管理安全策略。SELinux从Android 4.3开始引入Android，从Android 4.4开始默认设置为<em>强制</em>模式。这种强制访问控制系统有助于加强现有的访问控制权限，并试图防止权限提升攻击。这为未经授权控制您的设备设置了障碍，例如旨在恶意获取root访问权限的应用程序或漏洞。将SELinux设置为<em>在Android上默认执行</em>是保护普通用户免受此类攻击的第一步。</p>

<p>这个漏洞很容易被利用——事实上，这似乎是一加方面的一个巨大疏忽，而不是您想象的典型利用方式。首先，攻击者将OnePlus 3/3T重新启动到“快速启动”模式——如果你有物理访问权限，只需在启动期间按下音量增大按钮，但如果没有，你可以向设备发出ADB命令<code>adb reboot bootloader</code>。设备上的快速启动模式会暴露一个USB接口，该接口不允许任何安全敏感命令在锁定的设备上完成。但是在OnePlus 3/3T上，只需通过fastboot接口发出<code>fastboot oem selinux permissive</code>命令，就可以将SELinux模式从<em>强制</em>切换到<em>T5】许可 </em>。</p>

<pre> <code class="hljs ">fastboot oem selinux permissive<br/>...<br/><span class="hljs-selector-tag">OKAY</span> <span class="hljs-selector-attr">[ 0.045s]</span><br/><span class="hljs-selector-tag">finished</span>. <span class="hljs-selector-tag">total</span> <span class="hljs-selector-tag">time</span>: 0<span class="hljs-selector-class">.047s</span><br/><br/>....<br/><br/>OnePlus3:/ $ getenforce<br/>Permissive<br/>OnePlus3:/ $<br/></code> </pre>
<p>让问题更加复杂的是，OnePlus 3和3T在“关于屏幕”中没有任何条目来提及设备的当前SELinux状态。如果受害者没有看到漏洞被积极利用，他们将继续保持对其设备受损状态的遗忘。基于Android 6.0的公开测试版和Android 7.0的正式版都缺少“关于屏幕”中的SELinux状态条目。</p>





<p>有几个应用程序可以将SELinux状态切换到许可状态，比如SELinuxModeChanger 应用程序。通过这种方法切换SELinux不允许状态在重新启动时保持不变。不过，你可以<a href="https://forum.xda-developers.com/g2-mini/general/guide-how-to-set-selinux-to-permissive-t3329439">利用脚本</a>在硬重启时维护<em>许可</em> SELinux状态。这两种方法都需要root访问权限，这意味着用户已经知道他们面临的风险。但是使用上述漏洞将SELinux模式更改为<em>许可</em>的主要区别在于，它不仅在硬重启后继续存在<strong>，而且在不需要root访问权限</strong>的情况下继续存在<strong>。</strong></p>

<p>目前还没有针对该漏洞的补救措施。</p>

<hr/>

<p><strong>更新:</strong></p>

<p><span>我们联系了<a href="http://forum.xda-developers.com/member.php?u=4800121"> Sultanxda </a>，他是一加设备最知名的定制ROM开发者之一，看看他是否能帮助我们了解更多关于这个问题的信息。他及时挖掘代码找到根源，这是他找到的:</span></p>

<p/><p><em><span>“fast boot OEM selinux&lt;state&gt;”命令的工作方式是在引导linux时在内核命令行上添加一个额外的参数。额外的参数以“androidboot.selinux= &lt;状态&gt;的形式出现，其中&lt;状态&gt;可以是“许可的”。事情变得有趣了:“机器人启动。内核命令行上的一些参数由Android的init解析。在一个普通的Android产品版本中(“用户”版本),“androidboot.selinux”参数被完全忽略，selinux总是被强制执行。所以这个bug由两个问题组成:</span> </em></p>

<ol> <li><em> <span>用户可以让引导加载程序传递一个标志，这个标志通常会使selinux在工程/调试ROM构建上变得许可</span> </em></li> <li><em> <span>一加修改了Android的init，以纪念“androidboot.selinux”标志，甚至用于生产ROM版本</span> </em></li> </ol>

<p/><p><em> <span>这里是Android的init被配置为忽略生产版本的“androidboot.selinux”标志:</span><a href="https://android.googlesource.com/platform/system/core/+/android-6.0.0_r41/init/Android.mk#7"><span>https://Android . Google source . com/platform/system/core/+/Android-6 . 0 . 0 _ r41/init/Android . MK # 7</span></a></em></p>

<p/><p><em> <span>源代码中的ALLOW_DISABLE_SELINUX标志仅针对userdebug和工程构建</span> </em>设置为1</p>

<p/><p><em> <span>(我的ROM不受此影响，因为我在生产(用户)模式下构建我的ROM)</span></em></p>

<p/><p><em> <span>所以“androidboot.selinux”在我的ROM中根本就被忽略了，“fastboot oem selinux &lt; state &gt;”命令似乎也是一加创建的，因为CAF的公共bootloader源代码中不存在这样的命令。在我的脑海中，我可以想到4种方法来解决这个问题，为用户解锁引导:</span> </em></p>

<ol> <li><em> <span>十六进制编辑引导加载程序，将字符串“selinux”的所有实例更改为不同的形式(如“sclinux”)，以便Android的init </span> </em>不会识别该标志</li> <li><em>十六进制编辑OxygenOS中的Android init二进制文件，将“androidboot.selinux”的所有实例替换为不同的实例(如“androidboot.sclinux”)，以便Android init不会识别androidboot.selinux标志</em></li> <li><em> <span>给内核命令行驱动添加一个类似于my SafetyNet bypass的hack，以便对Android的init</span>T3隐藏“androidboot.selinux”标志</em></li> </ol>

<p>我们要感谢Sultanxda花费时间和精力帮助我们弄清楚幕后发生了什么。我们也联系了一加，他了解情况并正在调查此事。</p>

<hr/>

<p>我们希望一加公开承认这个严重的问题，并在解决问题的计划上保持透明。</p>

 </div>


</div>    
</body>
</html>