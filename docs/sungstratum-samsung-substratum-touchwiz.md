# 底层如何给不灵活的 TouchWiz 带来更多选择

> 原文：<https://www.xda-developers.com/sungstratum-samsung-substratum-touchwiz/>

Android 主题化已经走过了漫长的道路，从粗糙的编辑到底层，再到现在的 **Sungstratum** 。几年前，Android 讨论中的“主题”一词经常被“选择器”一词取代，这是对 CyanogenMod 中 T-Mobile 主题选择器的认可，它奠定了 Android 成为主题天堂的基础。修改操作系统外观的能力为用户提供了另一个定制维度，允许他们做出改变，使他们的设备更加个性化。

良好的工作继续在两个不同的方向。主题选择器演变成了 CyanogenMod 主题引擎，但是尽管在主题资源上投入了多年的努力，当其他选择出现时，CMTE 变得过时了。

* * *

**RRO &图层**

当索尼的代码贡献以称为 **[运行时资源覆盖(RRO)](https://developer.sonymobile.com/2014/04/22/sony-contributes-runtime-resource-overlay-framework-to-android-code-example/)** 的新框架的形式被 AOSP 接受时，替代方案之一的基础就奠定了。这个框架提供了在运行时替换应用程序资源的能力(因此得名)。“覆盖层”本身早在 Gingerbread(可能更早)就已经出现并在 Android 中得到支持，主要用于交换资源，使应用程序在特定设备上工作。索尼的 RRO 方法包括修改资产管理器以接受 apk，apk 使用映射到设备上其他相应资源的资源。来自 apk 的这些新资源仅在运行时覆盖在基础资源之上，允许系统继续工作，就好像这些新资源一直是它的一部分一样。

在 Lollipop 5.0 公开之前，RRO 框架被合并到 AOSP 中，但是由于其他变化，5.0 的最初几个版本的部分框架被破坏了。Android 6.0 Marshmallow 的开发者预览版首次加入了一个功能虽然有限的 RRO 框架，打开了可定制性的大门。因此，除非原始设备制造商故意试图偏离现有的 Android 主题选项，否则在 Android 中如何实现“主题”的方法可以保持一定程度的一致性。

当 AOSP 在玩弄 RRO 并寻找整合这一切的最佳方式时，一个名为 **BitSyko** 的开发团队正在共同努力，名为“**层**”。层扩展了 Android 5.1 Lollipop 中的 stock RRO 功能，实现了更复杂的资源切换，并允许比 stock RRO 更多的主题元素控制。因为图层是建立在 RRO 之上的，ROM 制作者需要添加额外的代码来启用他们的 ROM 中的图层功能，因为不是所有的图层主题都可以在棉花糖中的普通 RRO 上工作。

与此同时，索尼继续努力实现 Android 主题化。它开始致力于 **OMS(覆盖管理服务)**，这是一个管理覆盖的客户端，允许提供商动态控制优先级，启用和禁用覆盖。 OMS 正被并入 AOSP，并将进入 Android O 。XDA 公认的开发者 [nicholaschum](https://forum.xda-developers.com/member.php?u=3605033) 能够通过他的消息来源证实 Android O 将会展示“动态覆盖”，这被认为是参考了 OMS。

OMS 引起了与层的冲突，因为传统上，这样的功能是在主题的控制之下。为了处理 OMS 提出的问题以及扩展层的功能，BitSyko 再次合作(并将他们自己重新命名为 **[projekt。]** )创建**底层**。 [Substratum 是一个具有 OMS 功能的客户端](https://www.xda-developers.com/layers-manager-is-being-deprecated-in-favor-of-substratum/)，它试图将图层功能与 OMS 相协调，并且还借用了其他过去主题化解决方案中的其他元素。覆盖图不再像现在一样相互重叠以主题化单个元素，所有需要的元素都被注入到一个单独的覆盖图中。像在设备上编译这样的特性允许应用主题而不需要在两次修改之间重启，这使得最终用户尝试主题变得更加容易。Substratum 自问世以来一直在积极开发中，列出它的所有特性和增加的功能超出了本文的范围，所以我们将转移到本文的真正主题。

* * *

## 底层进入太阳层

如前一节所述，底层最初是作为扩展库存 OMS 功能和库存 RRO 功能的一种方式(通过层)。Substratum 旨在与基于 AOSP 的 rom 一起使用，因为大多数其他原始设备制造商会做出相互冲突的更改，不允许 Substratum 与他们在编辑过的 UX 皮肤(如三星的皮肤)上的修改共存。

三星自己也在开发一个主题化解决方案，用于 Nougat 上自己的设备。与索尼不同的是，三星没有表现出将主题代码回馈给 AOSP 的兴趣。但是由于三星的解决方案相当简单，AOSP 并没有损失太多。三星 Touchwiz 中的主题化解决方案在三星 Galaxy S6 上真正出现，但正如前面提到的，它在尝试实现什么方面受到了相当大的限制。在此之前，从 Galaxy Alpha 开始的试验是有限的，尽管大多数系统 UI 元素都超出了它的范围。例如，主题可以改变壁纸和图标，以及一些三星股票应用程序，如拨号器、联系人、信息和通知区域。

事实证明，三星的主题引擎*扩展了在 AOSP 发现的* RRO。三星在扩展 RRO 后也重新创建了他们自己的 OMS 内部版本，因此他们对 RRO 和 OMS 的实现都不同于 AOSP。但令人惊讶的是，数量并不多——考虑到 Touchwiz 的独特性和复杂性，这是一种反常的行为。使用较新的三星旗舰的主题用户报告说，他们可以安装 RRO 覆盖，并让他们主题第三方应用程序。

这是团队[项目]的提示。]需要研究在底层上官方支持三星设备。该团队从他们的应用程序的 RRO/Legacy 部分转换了少量代码，但他们没有请求 root 并要求重新启动，而是激发了特定的意图，以便安装覆盖层。然后，该团队努力确保受主题影响的应用程序在后台被强制关闭，以确保在下一次发布时进行全面的资产刷新。

我们请 XDA 知名开发人员 nicholaschum 向我们介绍了该团队在对抗三星 RRO-OMS 的闭源实现时所面临的挑战:

我们所面临的挑战是相当模糊的，许多不了解主题化系统的人都不知道，不管是开源的还是闭源的——每件事都有它自己的试错阶段。在这种情况下，与三星合作，我偶然发现了许多问题，但主要的一个问题是系统意图在安装完成后不会被触发覆盖-例如利用带有“Android . intent . action . package _ ADDED”的广播接收器-主题服务拒绝任何不属于特定三星主题服务权限的系统签名的内容，因此最困难的部分是我们必须找到一种解决方法。

我们使用 Substratum 和三星主题引擎的方式是利用和他们一样的系统。他们使用索尼的资源运行时覆盖系统的高度修改版本，缩写为 RRO 或在 Substratum 用户中称为 legacy。然而，不同的是，三星主题有一个额外的权限，从设置中隐藏这些覆盖，所以你不能手动卸载它们。我们使用相同的系统，但是我们利用 AOSP/索尼的实现，这就是为什么三星主题可以完全主题化框架，而底层覆盖不能触及不存在的中介目标“fwk”-正如我们都知道框架只是“android”包名。

似乎很奇怪。]能够相对轻松地与三星的 RRO 实现一起工作。任何曾经在三星设备上工作过的人都可以证明三星制造产品有多困难。我们询问了该团队在停靠期间遇到的任何具体障碍:

确实有某种安全机制影响了一些用户——覆盖在启动时恢复。这是由于三星启动设备的方式。由于我们大多都在 7.0 的 TouchWiz/Samsung 体验上，我们使用了一种新的“优化应用程序”的方法(当你更新你的手机时，你可以看到这一点，它会显示一个带有 Android Nougat 图标的通知，说它正在后台升级)，所以这种优化应用程序的方式也会卸载目标包，最终会中断启动时的 idmapping 过程(由于目标包不存在)，因此，一些人在重启后会遇到覆盖卸载。

你也可以在三星的一些主题中看到这种情况，尤其是@envy~，他将默认的导航条颜色设置为黑色，而实际的默认颜色是白色。设置为黑色后，您可以打开键盘，导航条保持黑色。这将在重启时随机恢复，在许多设备上也是如此。

随着主题化重新得到重视，Substratum 在像 Sungstratum 这样的分支上有什么计划？

在未来的道路上，我们将为我们当前的用户合并一个小应用程序到我们的插件中，这样如果他们设备上安装的所有主题都是从 XDA 安装的，他们将能够停止三星主题服务。所以那些将使用三星主题格式的 XDA 主题的人，你将能够使用插件来阻止三星的服务在每次重启后将其恢复到股票主题(因为它不是从三星商店正式安装的)。它将需要一个免费的三星开发者密钥，可以从他们的网站上获得，但它将与 sungstratum 插件下载预先捆绑在一起。

* * *

随着 AOSP 和 Android O 最近和即将发生的变化，看起来谷歌曾经羽翼未丰的操作系统将有更多的个性化传递给用户。某些原始设备制造商甚至计划放弃他们的定制用户界面和 UX 插件，转而支持 AOSP，而三星等其他公司也有自己的主题解决方案。我们设想在未来，主题将在更多人的用户体验中扮演重要角色——在这样的操作系统中，你可以真正控制你的设备的外观，你可以为自己量身定制用户界面美学。如果没有这个令人敬畏的社区的集体力量和 Substratum 这样的项目，我们就无法实现这样的未来。

* * *

在我们的底层论坛中查看三星牛轧糖的底层整合！[**GitHub 上的底层**](https://github.com/substratum)