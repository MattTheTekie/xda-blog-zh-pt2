# OnePlus 3/3T 引导加载程序漏洞允许在快速引导中将 SELinux 更改为许可模式

> 原文：<https://www.xda-developers.com/oneplus-33t-bootloader-vulnerability-allows-changing-of-selinux-to-permissive-mode-in-fastboot/>

一加 3 和 T2 一加 3T 是你现在能买到的最好的手机。虽然即将到来的 2017 年旗舰尚未向消费者展示，但在他们缺席的情况下， [OnePlus 3/3T 以实惠的价格主导了真实世界的性能](https://www.xda-developers.com/dissecting-speed-how-oneplus-leveraged-excellent-real-world-performance/)。

**但是，如果我们要公平地评估这款设备，**我们需要承认，尽管一加尽了最大努力，OnePlus 3/3T 也不是没有缺点。例如，我们之前报道过安全问题，比如当你在手机上检查更新时，[一加通过网络泄露了 IMEI 细节。现在，我们有另一个安全问题要添加到列表中，这个问题具有潜在的更危险的后果。](https://www.xda-developers.com/be-warned-oneplus-is-still-leaking-your-imei-when-you-check-for-updates/)

OnePlus 3/3T 的引导加载程序中的漏洞为恶意攻击打开了大门。IBM X-Force 应用程序安全研究团队的 Roee Hay 发现，IBM X-Force 交换平台上的[显示，该漏洞允许攻击者操纵设备上的 SELinux 状态，从而将其切换到许可模式。所有攻击者需要的是**物理访问**设备，或者**远程访问 ADB 连接**设备。](https://exchange.xforce.ibmcloud.com/collection/OnePlus-3-fastboot-oem-selinux-permissive-Vulnerability-d38d8557f1a01570539151c782d52aaf)

安全增强的 Linux 是一个 Linux 内核安全模块，允许访问和管理安全策略。SELinux 从 Android 4.3 开始引入 Android，从 Android 4.4 开始默认设置为*强制*模式。这种强制访问控制系统有助于加强现有的访问控制权限，并试图防止权限提升攻击。这为未经授权控制您的设备设置了障碍，例如旨在恶意获取 root 访问权限的应用程序或漏洞。将 SELinux 设置为*在 Android 上默认执行*是保护普通用户免受此类攻击的第一步。

这个漏洞很容易被利用——事实上，这似乎是一加方面的一个巨大疏忽，而不是您想象的典型利用方式。首先，攻击者将 OnePlus 3/3T 重新启动到“快速启动”模式——如果你有物理访问权限，只需在启动期间按下音量增大按钮，但如果没有，你可以向设备发出 ADB 命令`adb reboot bootloader`。设备上的快速启动模式会暴露一个 USB 接口，该接口不允许任何安全敏感命令在锁定的设备上完成。但是在 OnePlus 3/3T 上，只需通过 fastboot 接口发出`fastboot oem selinux permissive`命令，就可以将 SELinux 模式从*强制*切换到*许可* 。

```
 fastboot oem selinux permissive
...
OKAY [ 0.045s]
finished. total time: 0.047s

....

OnePlus3:/ $ getenforce
Permissive
OnePlus3:/ $

```

让问题更加复杂的是，OnePlus 3 和 3T 在“关于屏幕”中没有任何条目来提及设备的当前 SELinux 状态。如果受害者没有看到漏洞被积极利用，他们将继续保持对其设备受损状态的遗忘。基于 Android 6.0 的公开测试版和 Android 7.0 的正式版都缺少“关于屏幕”中的 SELinux 状态条目。

有几个应用程序可以将 SELinux 状态切换到许可状态，比如 SELinuxModeChanger 应用程序。通过这种方法切换 SELinux 不允许状态在重新启动时保持不变。不过，你可以[利用脚本](https://forum.xda-developers.com/g2-mini/general/guide-how-to-set-selinux-to-permissive-t3329439)在硬重启时维护*许可* SELinux 状态。这两种方法都需要 root 访问权限，这意味着用户已经知道他们面临的风险。但是使用上述漏洞将 SELinux 模式更改为*许可*的主要区别在于，它不仅在硬重启后继续存在**，而且在不需要 root 访问权限**的情况下继续存在**。**

目前还没有针对该漏洞的补救措施。

* * *

**更新:**

我们联系了 [Sultanxda](http://forum.xda-developers.com/member.php?u=4800121) ，他是一加设备最知名的定制 ROM 开发者之一，看看他是否能帮助我们了解更多关于这个问题的信息。他及时挖掘代码找到根源，这是他找到的:

*“fast boot OEM selinux<state>”命令的工作方式是在引导 linux 时在内核命令行上添加一个额外的参数。额外的参数以“androidboot.selinux= <状态>的形式出现，其中<状态>可以是“许可的”。事情变得有趣了:“机器人启动。内核命令行上的一些参数由 Android 的 init 解析。在一个普通的 Android 产品版本中(“用户”版本),“androidboot.selinux”参数被完全忽略，selinux 总是被强制执行。所以这个 bug 由两个问题组成:*

1.  *用户可以让引导加载程序传递一个标志，这个标志通常会使 selinux 在工程/调试 ROM 构建上变得许可*
2.  *一加修改了 Android 的 init，以纪念“androidboot.selinux”标志，甚至用于生产 ROM 版本*

*这里是 Android 的 init 被配置为忽略生产版本的“androidboot.selinux”标志:[https://Android . Google source . com/platform/system/core/+/Android-6 . 0 . 0 _ r41/init/Android . MK # 7](https://android.googlesource.com/platform/system/core/+/android-6.0.0_r41/init/Android.mk#7)*

*源代码中的 ALLOW_DISABLE_SELINUX 标志仅针对 userdebug 和工程构建* 设置为 1

*(我的 ROM 不受此影响，因为我在生产(用户)模式下构建我的 ROM)*

*所以“androidboot.selinux”在我的 ROM 中根本就被忽略了，“fastboot oem selinux < state >”命令似乎也是一加创建的，因为 CAF 的公共 bootloader 源代码中不存在这样的命令。在我的脑海中，我可以想到 4 种方法来解决这个问题，为用户解锁引导:*

1.  *十六进制编辑引导加载程序，将字符串“selinux”的所有实例更改为不同的形式(如“sclinux”)，以便 Android 的 init* 不会识别该标志
2.  *十六进制编辑 OxygenOS 中的 Android init 二进制文件，将“androidboot.selinux”的所有实例替换为不同的实例(如“androidboot.sclinux”)，以便 Android init 不会识别 androidboot.selinux 标志*
3.  *给内核命令行驱动添加一个类似于 my SafetyNet bypass 的 hack，以便对 Android 的 initT3 隐藏“androidboot.selinux”标志*

我们要感谢 Sultanxda 花费时间和精力帮助我们弄清楚幕后发生了什么。我们也联系了一加，他了解情况并正在调查此事。

* * *

我们希望一加公开承认这个严重的问题，并在解决问题的计划上保持透明。