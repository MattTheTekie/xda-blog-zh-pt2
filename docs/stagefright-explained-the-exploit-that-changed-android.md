# 舞台恐惧:改变安卓的漏洞

> 原文：<https://www.xda-developers.com/stagefright-explained-the-exploit-that-changed-android/>

Android 的最大优势之一主要是它的开源特性，允许利益相关者以适合他们特定需求的方式派生、修改和重新发布操作系统。但是，当涉及到恶意软件和安全问题时，开源的这一优势就像一把双刃剑。当一个项目中有很多有能力的贡献者，并且他们的源代码可以免费获得时，就更容易找到并修补缺陷。然而，在源级别解决问题并不意味着问题在最终消费者手中得到解决。因此，在为数据敏感型企业选择操作系统时，Android 并不是首选。

在 2014 年谷歌 I/O 大会上，谷歌发布了用于工作的 Android 程序，首次推动了一个更加安全和企业友好的生态系统。Android For Work 采用了双配置文件方法来满足企业需求，IT 管理员可以为员工创建不同的用户配置文件——一个侧重于工作，其他配置文件供员工个人使用。通过使用基于硬件的加密和管理员管理的策略，工作和个人数据保持清晰和安全。随后，Android For Work 在接下来的几个月里受到了更多的关注，主要关注点是设备针对恶意软件的安全性。谷歌还计划[为所有将与 Android Lollipop 一起发布的设备](http://www.xda-developers.com/android-l-data-encryption/)启用全设备加密，但由于性能问题，这一举措被取消，OEM 厂商可以选择实施。

推动安全的 Android 不完全是谷歌的工作，因为三星通过其对 AOSP 的贡献在这方面发挥了相当重要的作用，最终 T2 加强了 Android For Work。然而，当谈到企业采用的普及性时，Android 中最近的安全漏洞和漏洞表明了一项艰巨的任务。最近的 Stagefright 漏洞就是一个很好的例子。

## 内容:

## 什么是怯场？

简单来说，Stagefright 是一种利用 Android 中名为 [libstagefright](https://source.android.com/devices/media.html) 的代码库进行媒体播放的漏洞。libstagefright 引擎用于执行通过彩信以恶意视频形式接收的代码，因此只需受害者的手机号码即可成功实施攻击。

我们联系了我们的内部专家——XDA 资深公认开发人员和开发人员管理员 [pulser_g2](http://forum.xda-developers.com/member.php?u=2178960) ,以提供更详细的解释。

"*当我写这篇文章的时候，[Stagefright]漏洞将会在 BlackHat [ [Link](https://www.blackhat.com/us-15/briefings.html#stagefright-scary-code-in-the-heart-of-android) ]上得到解释，尽管还没有幻灯片或白皮书的细节。*

因此，我给出的解释更多的是对正在发生的事情的一个粗略的想法，而不是一个完全准确的深度解释。

*有许多不同的 bug 组成 Stagefright，这些 bug 都有自己的 CVE [ [常见漏洞&曝光](https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures)号用于跟踪:*

*   ***【CVE】2015-1538***
*   ***【CVE】2015-1539***
*   ***CVE-2015-3824***
*   ***CVE-2015-3826***
*   ***CVE-2015-3827***
*   ***CVE-2015-3828***
*   ***CVE-2015-3829***

不幸的是，可用的补丁并没有直接链接到每个 CVE(它们应该是这样的)，所以解释起来会有点麻烦。

### ***1。【CVE-2015-1538】***

在 MPEG4 处理代码中，3GPP 元数据(当视频是 3GPP 格式时，描述格式和其他额外信息的东西)处理代码有问题。它不拒绝数据过大的元数据，而是只检查它是否太小。这意味着攻击者有可能创建一个“已修改”或“已损坏”的文件，该文件的元数据部分比它应有的要长。

编写代码来处理“不可信”数据(即来自用户或代码外部的任何其他地方)的一大挑战是处理可变长度数据。视频就是一个很好的例子。软件需要根据运行情况动态分配内存。

在这种情况下，创建了一个缓冲区作为指向某个内存的指针，但是它所指向的数组的长度太短了一个元素。然后元数据被读入这个数组，这个数组中的最后一个条目可能不是“null”(或零)。重要的是数组中的最后一项是零，因为这是软件告诉数组结束的方式。通过将最后一个值设置为非零值(因为数组中可能有一个元素太小)，恶意代码可能会被另一部分代码读取，并读入过多的数据。它不会在这个值的末尾停止，而是会继续读入它不应该读取的其他数据。

*(参赛作品: [OmniROM Gerrit](https://gerrit.omnirom.org/#/c/14226/) )*

### ***2。【CVE-2015-1539】*T3**

考虑到元数据是一个 UTF-16 字符串，元数据的最短可能“大小”应该是 6 个字节。该代码采用整数值大小，并从中减去 6。如果这个值小于 6，减法将“下溢”并绕回，我们将得到一个非常大的数字。想象一下，比如你只能从 0 数到 65535。如果你把数字 4 减去 6，你就不会低于零。所以你回到 65535，从那里开始数。这就是这里正在发生的事情！

*如果收到的长度小于 6，可能会导致帧被错误解码，因为 byteswap 进程使用变量 len16，其值是从(size-6)开始的计算中获得的。这可能会导致比预期更大的交换操作发生，从而以意外的方式更改帧数据中的值。*

*(参赛作品: [OmniROM Gerrit](https://gerrit.omnirom.org/#/c/14227/) )*

### ***3。【CVE-2015-3824】***

一件大事！这个很恶心。与最后一个问题正好相反——整数溢出，整数会变得“太大”。如果你达到 65535(举例来说),不能再数得更高了，你会转身，下一步到 0！

如果你基于此分配内存(Stagefright 就是这么做的！)，那么数组中分配的内存就会非常少。当数据放入其中时，它可能会用恶意文件创建者控制的数据覆盖不相关的数据。

*(参赛作品: [OmniROM Gerrit](https://gerrit.omnirom.org/#/c/14228/) )*

### ***4。【CVE-2015-3826】***

又一个讨厌的家伙！与上一个非常相似——另一个整数溢出，其中数组(用作缓冲区)会变得太小。这将允许不相关的内存被覆盖，这也是不好的。可以将数据写入内存的人可以破坏其他不相关的数据，并可能利用这一点让他们控制的一些代码在您的手机上运行。

*(参赛作品: [OmniROM Gerrit](https://gerrit.omnirom.org/#/c/14230/) )*

### ***5。【CVE-2015-3827】***

与最后这些非常相似。在跳过一些内存时使用了一个变量，这可以在减法过程中变成负数(如上)。这将导致一个非常大的“skip”长度，溢出缓冲区，访问不应该访问的内存。

*(参赛作品: [OmniROM Gerrit](https://gerrit.omnirom.org/#/c/14229/) )*

也有一些(潜在的)相关修复看起来也已经进入了[Android] 5.1。

*(参赛作品: [OmniROM Gerrit](https://github.com/omnirom/android_frameworks_av/commit/030d8d0a557097b88d6ecbf6d04823213512b620) )*

这增加了检查以阻止过去的安全修复问题，增加了边界检查，这本身可能会溢出。在 C #中，可以表示为有符号整数的数字存储为有符号整数。否则它们在操作期间保持不变。在这些检查中，一些整数可能是有符号的(而不是无符号的)，这将在以后减少它们的最大值，并允许发生溢出。

*(参赛作品: [OmniROM Gerrit](https://github.com/omnirom/android_frameworks_av/commit/edd4a76eb4747bd19ed122df46fa46b452c12a0d) )*

*更多的整数下溢(数字太低，然后对这些数字进行减法，让它们变成负数)。这再次导致了大量的，而不是少量的，并导致了与上述相同的问题。*

*(参赛作品: [OmniROM Gerrit](https://github.com/omnirom/android_frameworks_av/commit/0e4e5a8c09c63548f2a00c77ab5038b7703384bc) )*

*最后，另一个整数溢出。和以前一样，马上就要用到别的地方了，可能会溢出来。*

*(Ref:[OmniROM Gerrit](https://github.com/omnirom/android_frameworks_av/commit/5c134e6b2047b10877f02a46f4bb293537269f00))*

## 怯场有多严重？

根据母公司 Zimperium Research Labs 发布的[博客帖子](http://blog.zimperium.com/experts-found-a-unicorn-in-the-heart-of-android/)，Stagefright 漏洞可能会使 95%的 Android 设备(约 9.5 亿)暴露于该漏洞，因为它会影响运行 Android 2.2 及更高版本的设备。更糟糕的是，Jelly Bean 4.3 之前的设备面临“最大风险”，因为这些设备不包含针对此漏洞的足够缓解措施。

关于舞台恐惧可能造成的伤害，pulser_g2 评论道:

[block quote author = " pulser _ G2 "]“stage fright 本身就可以让系统用户通过电话进行访问。不过，你必须绕过 ASLR(地址空间布局随机化)才能真正滥用它。现在还不知道这一目标是否已经实现。这种利用让“任意代码”作为系统或媒体用户在您的设备上运行。这些人可以访问设备上的音频和摄像头，系统用户是启动 root 漏洞利用的绝佳场所。还记得你用来给手机 root 的所有惊人的 root 漏洞吗？

这些都有可能被悄悄地用来获取你的设备根！谁拥有根，谁就拥有电话。他们必须绕过 SELinux，但是 TowelRoot 做到了，PingPong 也做到了。一旦他们扎根，你手机上的一切对他们都是开放的。消息、密钥等。"[/blockquote] ![](img/d813250580daf2ab54960b2e33af2481.png)谈到最坏的情况，只需要一条彩信就可以发送代码并触发这种利用。用户**甚至不需要打开消息**，因为许多消息应用在用户与之交互之前会对彩信进行预处理。这不同于鱼叉式网络钓鱼攻击，因为用户可能完全不知道攻击成功，从而危及手机中所有当前和未来的数据。

## Stagefright 有什么不同于其他“海量漏洞”的地方？

> “所有的漏洞都对用户构成一定的风险。这种攻击尤其危险，因为如果有人找到远程攻击它的方法(这是可能的，如果找到了绕过 ASLR 的方法)，它可能会在你意识到自己受到攻击之前就被触发"

Android 安装程序劫持、FakeID 等旧漏洞以及 TowelRoot 和 PingPong 等根漏洞在某些时候需要用户交互才能执行。虽然它们仍在“利用”如果被恶意使用会造成许多伤害的事实，但事实仍然是，Stagefright 理论上只需要受害者的手机号码就可以将他们的手机变成特洛伊木马，因此最近几天受到了如此多的关注。

不过，Android 并不完全受制于这一漏洞。Android 安全首席工程师 Adrian Ludwig 在 Google+的一篇文章中提出了一些担忧:

> [block quote author = " Adrian Ludwig "]“有一个常见的错误假设，即任何软件缺陷都可以变成安全漏洞。事实上，大多数错误是不可利用的，Android 已经做了很多事情来提高这些几率...
> 
> 这里列出了自冰淇淋三明治(Android 4.0)以来引入的一些技术。其中最著名的称为地址空间布局随机化(ASLR)，它在 Android 4.1 中完全完成，支持 PIE(位置独立可执行文件)，现在在 85%以上的 Android 设备上使用。这项技术使得攻击者更难猜测代码的位置，而这是他们成功利用漏洞所必需的...
> 
> 我们没有停止使用 ASLR，我们还添加了 NX、FortifySource、只读重定位、堆栈加那利等等。"[/blockquote]

然而，不可否认的是，怯场对 Android 的未来来说是一个严重的问题，正因为如此，相关利益方正在认真对待这个问题。Stagefright 还强调了房间里的白象——碎片和更新最终到达消费者手中的问题。

## 更新的困境

说到更新，很高兴看到 OEM 开始对用户的安全负责，因为许多人已经承诺改善更新过程，特别是针对 Stagefright 等漏洞加入安全修复和补丁。

作为首批发布官方声明的公司之一，谷歌承诺为其大多数 Nexus 设备(包括近 3 年的 Nexus 4)每月进行安全更新(除了计划中的操作系统和平台更新之外)。三星也紧随其后，宣布将与运营商和合作伙伴合作实施[每月安全更新计划](http://global.samsungtomorrow.com/samsung-announces-an-android-security-update-process-to-ensure-timely-protection-from-security-vulnerabilities/)，但它未能详细说明这一实施的设备和时间表细节。这很有趣，因为它提到了与运营商合作进行安全更新的“快速通道”方法，所以我们可以期待运营商设备上更频繁的更新(尽管是基于安全的，但希望它也能加速固件升级)。

其他 OEM 厂商也加入了进来，其中包括 LG，它将加入[月度安全更新](http://www.wired.com/2015/08/google-samsung-lg-roll-regular-android-security-updates/)。摩托罗拉还宣布了将更新【Stagefright 修复程序的[设备列表，该列表包括该公司自 2013 年以来制造的几乎所有设备。索尼还表示](https://motorola-global-portal.custhelp.com/app/answers/prod_answer_detail/a_id/106654)[其设备也将很快收到补丁](http://www.xperiablog.net/2015/08/06/stagefright-vulnerability-fix-heading-to-xperia-z-series-this-month/)。

这一次，运营商也乐于提供更新。sprint[发布了一份声明](http://newsroom.sprint.com/blogs/devices-apps-and-services/helpful-information-on-android-stagefright.htm),称一些设备已经收到 Stagefright 补丁，更多设备计划进行更新。 [AT & T 也紧随其后](https://www.anrdoezrs.net/links/100122946/type/dlg/sid/UUxdaUeUpU15344/https://www.att.com/device-support/softwareupdates/?partner=LinkShare&siteId=JAF5WzpxbKM-CJDCaTaPShdLThgqeu9vdA)向一些设备发布补丁。威瑞森也发布了补丁，尽管这是一个缓慢的部署，优先考虑 Galaxy S6 Edge 和 Note 4 等高端智能手机。T-Mobile Note 4 也获得了 Stagefright 补丁更新。

作为最终用户，可以采取一些预防措施来减少被攻击的机会。首先，在手机上的信息应用中禁用彩信的自动检索。这应该可以控制不需要用户交互就能利用漏洞的情况。此后，一定要注意避免从未知和不可信的来源下载彩信中的媒体。

作为一名 XDA 超级用户，你也可以[编辑你的建造道具来禁用舞台恐惧](http://forum.xda-developers.com/showpost.php?p=62069940&postcount=8)。这并不是一种彻底且万无一失的避免怯场的方法，但如果你被困在一个旧的 Android 版本上，你可以抓住机会减少成功攻击的可能性。也有定制的 ROM 解决方案，其中大多数与 AOSP 同步源定期，因此，将有 Stagefright 修复纳入。如果您运行的是基于 AOSP 的 rom，强烈建议您更新到包含 Stagefright 补丁的较新版本的 ROM。你可以使用[这个应用](https://play.google.com/store/apps/details?id=com.zimperium.stagefrightdetector&hl=en)来检查你当前的日常驾驶是否受到 Stagefright 的影响。

## 安卓，后舞台恐惧

Stagefright 只不过是对 Android 及其碎片化和更新问题的一个警醒。它强调了如何没有一个明确的机制，通过这种机制，这些关键的修补程序可以及时推出到众多的设备。虽然 OEM 厂商正试图为设备推出补丁，但残酷的事实是，大多数补丁将仅限于最近的旗舰产品。其他非旗舰和旧设备，更不用说来自较小的 OEM 厂商的设备，将继续暴露在舞台恐惧之类的环境中。

这种利用也有好的一面:它确实重新引起了人们对 Android 更新过程的关注，并强调它不会吸引太多未来的公司将 Android 用于企业。随着谷歌致力于更大的企业采用，它将被迫重新考虑其更新策略和它允许 OEM 的控制量。

随着 Android M 日益接近市场发布，如果谷歌选择脱离越来越多的 AOSP 组件，转而支持其 Play 服务包，也就不足为奇了。毕竟，如果一款设备将搭载谷歌 Play 商店系统，这将是谷歌仍保留完全控制权的一个领域。这个[有它自己的缺点](http://www.xda-developers.com/sunday-debate-is-google-focusing-enough-on-aosp/)，用封闭源代码的墙替换开放源代码的区域。

当推测 Android 的未来时，有一个(非常小的)可能性，谷歌也可能限制 OEM 厂商对 AOSP 的改变。随着 [RRO 框架](http://www.xda-developers.com/android-m-dev-preview-adds-functional-rro-framework/)出现在 Android M 的功能状态中，Google 可以限制 OEM 厂商仅仅以 RRO 皮肤的形式进行修饰性的改变。这应该允许更快的更新部署，但代价是 OEM 厂商没有机会完全定制 Android。

另一种可能的途径是强制所有与谷歌 Play 商店一起运输的设备在固定的时间段(可能是两年)内接收有保证的安全更新。Play Services 框架可用于检查重要的安全更新和补丁的存在，如果不符合，将取消对 Play Store 的访问。

## 结束语

这仍然是猜测，因为没有好的方法来解决这个问题。除非采取非常极权的方法，否则在解决问题的过程中总会有一些缺点。由于 Android 设备数量庞大，跟踪每个设备的安全状态将是一项非常艰巨的任务。当务之急是重新思考 Android 的更新方式，因为目前的方式肯定不是最好的。我们 XDA 开发人员希望 Android 在与谷歌的闭源计划合作的同时，仍然保持其开源的根基。

你的手机容易怯场吗？你认为你的手机会收到怯场补丁吗？请在下面的评论中告诉我们！